<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‚‘ç‰¹ä½©çŸ¥è­˜æ®¿å ‚ V38</title>
    <style>
        /* æ¨£å¼ä¿æŒä¸è®Š */
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; margin: 0; padding: 0; background: #000; color: #333; user-select: none; }
        #bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url('bg_knowledge.jpg'); background-size: cover; background-position: center; filter: blur(3px) brightness(0.5); z-index: -1; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding-bottom: 100px; padding-top: 60px; box-sizing: border-box; position: relative; overflow-y: auto; }
        .header { position: absolute; top: 20px; width: 100%; text-align: center; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.8); z-index: 10; }
        .header h1 { margin: 0; font-size: 2.2rem; letter-spacing: 2px; }
        .header p { margin: 5px 0 0; color: #ddd; font-size: 0.9rem; }
        #grade-menu { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; width: 85%; max-width: 400px; border: 1px solid #fff; z-index: 20; }
        .g-btn { display: block; width: 100%; padding: 15px; margin: 15px 0; font-size: 1.3rem; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; transition: 0.2s; color: white; box-shadow: 0 5px 0 rgba(0,0,0,0.2); text-align: left; padding-left: 30px; position: relative; }
        .g-btn:active { transform: translateY(5px); box-shadow: none; }
        .g-btn span { font-size: 0.9rem; opacity: 0.9; display: block; font-weight: normal; margin-top: 5px; }
        .btn-low { background: linear-gradient(to right, #4caf50, #81c784); }
        .btn-mid { background: linear-gradient(to right, #ff9800, #ffb74d); }
        .btn-high { background: linear-gradient(to right, #2196f3, #64b5f6); }
        #game-interface { display: none; width: 90%; max-width: 600px; animation: slideUp 0.5s; z-index: 20; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.6); color: white; padding: 10px 20px; border-radius: 50px; margin-bottom: 15px; font-weight: bold; font-size: 1.2rem; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px); }
        #timer-bar-bg { width: 100%; height: 8px; background: #555; border-radius: 4px; margin-top: 5px; overflow: hidden; display: none; }
        #timer-bar-fill { height: 100%; width: 100%; background: #fb8c00; transition: width 1s linear; }
        #lives-container { color: #f44336; letter-spacing: 2px; display: none; margin-left:10px;}
        .quiz-card { background: #fff; border-radius: 20px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); text-align: center; position: relative; min-height: 220px; display: flex; flex-direction: column; justify-content: center; border: 4px solid #fff; }
        .subject-badge { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 5px 20px; border-radius: 20px; font-weight: bold; font-size: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .q-text { font-size: 1.6rem; font-weight: bold; line-height: 1.4; margin: 20px 0; color: #2c3e50; }
        .tf-area { display: flex; gap: 30px; margin-top: 30px; justify-content: center; }
        .tf-btn { width: 90px; height: 90px; border-radius: 50%; border: 5px solid #fff; font-size: 2.5rem; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.1s; }
        .tf-btn:active { transform: scale(0.9); }
        .btn-o { background: #4caf50; } .btn-x { background: #f44336; }
        .mcq-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .mcq-btn { padding: 15px; font-size: 1.1rem; font-weight: bold; border: none; background: #fff; color: #333; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 0 #ccc; border: 2px solid #eee; transition: 0.1s; min-height: 70px; display: flex; align-items: center; justify-content: center; }
        .mcq-btn:active { transform: translateY(4px); box-shadow: none; background: #eee; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100; flex-direction: column; backdrop-filter: blur(8px); }
        .modal.active { display: flex; animation: fadeIn 0.3s; } 
        .modal-box { background: #fff; padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; border: 5px solid #eee; }
        .rank-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #ddd; font-size: 1rem; color:#333; text-align:left; }
        #jetpay-navbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; height: 65px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 50px; border: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999; } .nav-item { text-decoration: none; color: #95a5a6; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; transition: 0.2s; } .nav-icon { font-size: 1.6rem; margin-bottom: 2px; } .nav-item:hover { color: #2c3e50; transform: translateY(-2px); } .nav-item-special { color: #e67e22; font-weight: bold; } .nav-item-special .nav-icon { background: #e67e22; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(230, 126, 34, 0.4); margin-top: -20px; border: 4px solid white; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } .feedback-popup { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; z-index: 100; text-shadow: 0 5px 20px rgba(0,0,0,0.5); display: none; animation: popIn 0.5s; } @keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0); } 80% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1); } }
    </style>
</head>
<body>

<div id="bg-layer"></div>
<div class="header"><h1>çŸ¥è­˜æ®¿å ‚</h1><p>éš¨æ©Ÿé¡Œåº«ç³»çµ± V38 - å…¨é¢ä¿®å¾©ç‰ˆ</p></div>

<div class="container">
    <div id="grade-menu">
        <h2 style="margin-top:0; color:#555;">è«‹é¸æ“‡æŒ‘æˆ°ç­‰ç´š</h2>
        <button class="g-btn btn-low" onclick="startGame('low')">ğŸ‘¶ ä½å¹´ç´š<span>ã€é€£å°ç‹ã€‘ä¸€é¡Œéƒ½ä¸èƒ½éŒ¯ï¼</span></button>
        <button class="g-btn btn-mid" onclick="startGame('mid')">ğŸ‘¦ ä¸­å¹´ç´š<span>ã€é€Ÿè®€ç‹ã€‘é™æ™‚60ç§’æ¥µé€ŸæŒ‘æˆ°ï¼</span></button>
        <button class="g-btn btn-high" onclick="startGame('high')">ğŸ§‘â€ğŸ“ é«˜å¹´ç´š<span>ã€ç©åˆ†ç‹ã€‘3æ¬¡å¤±èª¤æ©Ÿæœƒï¼</span></button>
    </div>
    <div id="game-interface">
        <div class="status-bar">
            <div id="status-left"><span class="status-icon">ğŸ”°</span><span id="grade-display">ä½å¹´ç´š</span></div>
            <div id="status-right"><span id="score-label">åˆ†æ•¸:</span> <span id="score-val" style="color:#ffeb3b; font-size:1.4rem;">0</span><span id="lives-container">â¤ï¸â¤ï¸â¤ï¸</span></div>
        </div>
        <div id="timer-bar-bg"><div id="timer-bar-fill"></div></div>
        <div class="quiz-card"><div class="subject-badge" id="subj-badge">ç§‘ç›®</div><div class="q-text" id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</div></div>
        <div id="tf-panel" class="tf-area" style="display:none;"><div class="tf-btn btn-o" onclick="checkAns(true)">O</div><div class="tf-btn btn-x" onclick="checkAns(false)">X</div></div>
        <div id="mcq-panel" class="mcq-area" style="display:none;"></div>
        <div style="text-align:center; margin-top:20px;"><button onclick="location.reload()" style="padding:10px 25px; background:rgba(0,0,0,0.5); color:fff; border:1px solid rgba(255,255,255,0.5); border-radius:20px; cursor:pointer;">æ”¾æ£„æŒ‘æˆ°</button></div>
    </div>
</div>

<div class="modal" id="result-modal">
    <div class="modal-box">
        <h1 id="res-title" style="margin:0 0 10px 0;">æŒ‘æˆ°çµæŸ</h1><p id="res-desc" style="color:#666;"></p><h2 id="res-score" style="font-size:3rem; color:#f44336; margin:10px 0;">0</h2>
        <p style="color:#999; font-size:0.9rem;">è«‹è¼¸å…¥åå­—ä¸Šå‚³æ¦®è­½æ¦œ</p>
        <input type="text" id="input-name" placeholder="ä¾‹å¦‚: 301 å°æ˜" style="padding:10px; width:80%; font-size:1.1rem; text-align:center; border:2px solid #ddd; border-radius:10px;"><br><br>
        <button onclick="submitScore()" style="width:100%; padding:15px; background:#2196f3; color:white; border:none; border-radius:10px; font-size:1.2rem; cursor:pointer; font-weight:bold;">ä¸Šå‚³æˆç¸¾</button>
        <button onclick="location.reload()" style="width:100%; padding:10px; background:#ddd; color:#555; border:none; border-radius:10px; margin-top:10px; cursor:pointer;">å›é¦–é </button>
    </div>
</div>

<div class="modal" id="rank-modal">
    <div class="modal-box" style="height:70vh; display:flex; flex-direction:column;">
        <h2 style="margin:0 0 15px 0;">ğŸ† è‹±é›„æ¦œ</h2>
        <div class="rank-tabs"><button class="g-btn btn-low" style="padding:5px; text-align:center; font-size:0.9rem;" onclick="loadRank('low')">ä½å¹´ç´š</button><button class="g-btn btn-mid" style="padding:5px; text-align:center; font-size:0.9rem;" onclick="loadRank('mid')">ä¸­å¹´ç´š</button><button class="g-btn btn-high" style="padding:5px; text-align:center; font-size:0.9rem;" onclick="loadRank('high')">é«˜å¹´ç´š</button></div>
        <div id="rank-list" style="flex:1; overflow-y:auto; margin-top:10px; border-top:1px solid #eee;">è¼‰å…¥ä¸­...</div>
        <button onclick="document.getElementById('rank-modal').classList.remove('active')" style="margin-top:10px; padding:10px; background:#ddd; border:none; border-radius:10px; cursor:pointer;">é—œé–‰</button>
    </div>
</div>

<div id="fb-correct" class="feedback-popup">âœ…</div><div id="fb-wrong" class="feedback-popup">âŒ</div>
<div id="jetpay-navbar"><a href="index.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>é¦–é </span></a><a href="simple_games.html" class="nav-item"><span class="nav-icon">ğŸ§©</span><span>ç°¡å–®</span></a><a href="adventure_map.html" class="nav-item"><span class="nav-icon">ğŸ°</span><span>é—–é—œ</span></a><a href="knowledge_games.html" class="nav-item nav-item-special"><span class="nav-icon">ğŸ“š</span><span>çŸ¥è­˜</span></a><a href="#" class="nav-item" onclick="openRank()"><span class="nav-icon">ğŸ†</span><span>æ’è¡Œ</span></a></div>

<script>
    // ğŸ”´ ğŸ”´ ğŸ”´ è«‹åœ¨ä¸‹æ–¹è²¼ä¸Šæ‚¨ GAS (Apps Script) çš„ç¶²å€ (V5.0) ğŸ”´ ğŸ”´ ğŸ”´
    const API_URL = "https://script.google.com/macros/s/AKfycbwKUB2BPH1jD7ch2yenKSokuHq15ktPk1UfORI0RVNYVL6_oIBISNr27MX5Yng-7i-DqA/exec";

    // === V38: äº”é‡å¹³è¡Œå®‡å®™é¡Œåº« (Set A ~ E) ===
    // ğŸ”´ å·²ä¿®å¾©æ‰€æœ‰ç¼ºæ¼çš„é¸é …ï¼Œç¾åœ¨å…¨éƒ¨éƒ½æ˜¯ 4 é¸ 1 (é™¤äº†æ˜¯éé¡Œ)
    const UNIVERSE = [
        // Set A: ç¶“å…¸åŸºç¤é¡Œ (V36 çš„å…§å®¹)
        {
            low: [{s:"ç”Ÿæ´»",q:"ç´…ç‡ˆåœï¼Œç¶ ç‡ˆè¡Œã€‚",a:true}, {s:"æ•¸å­¸",q:"5+5=10",a:true}, {s:"è‡ªç„¶",q:"é­šåœ¨æ°´è£¡æ¸¸",a:true}, {s:"è‹±æ–‡",q:"Appleæ˜¯è˜‹æœ",a:true}, {s:"åœ‹èª",q:"å¤§å°å°",a:true}],
            mid: [{s:"ç¤¾æœƒ",q:"é¦–éƒ½åœ¨å°åŒ—",o:["å°åŒ—","å°ä¸­","é«˜é›„","å°å—"],a:"å°åŒ—"}, {s:"æ•¸å­¸",q:"8x7=?",o:["56","48","64","54"],a:"56"}],
            high: [{s:"ç¤¾æœƒ",q:"æœ€é«˜å³°æ˜¯?",o:["ç‰å±±","é›ªå±±","é˜¿é‡Œå±±","é™½æ˜å±±"],a:"ç‰å±±"}, {s:"è‡ªç„¶",q:"å¤ªé™½ç³»æœ€å¤§?",o:["æœ¨æ˜Ÿ","åœŸæ˜Ÿ","åœ°çƒ","ç«æ˜Ÿ"],a:"æœ¨æ˜Ÿ"}]
        },
        // Set B: ç”Ÿæ´»æ‡‰ç”¨é¡Œ
        {
            low: [{s:"ç”Ÿæ´»",q:"å—å‚·è¦å»è­¦å¯Ÿå±€ã€‚",a:false}, {s:"æ•¸å­¸",q:"10å…ƒæ›5å€‹1å…ƒã€‚",a:false}, {s:"è‡ªç„¶",q:"ä¸‹é›¨æœƒæœ‰å½©è™¹ã€‚",a:true}, {s:"è‹±æ–‡",q:"Dogæ˜¯è²“ã€‚",a:false}, {s:"åœ‹èª",q:"ç­†æ˜¯ç”¨ä¾†å¯«å­—ã€‚",a:true}],
            mid: [{s:"ç¤¾æœƒ",q:"å¯„ä¿¡ç”¨ä»€éº¼?",o:["éƒµç¥¨","è»Šç¥¨","ç™¼ç¥¨","éˆ”ç¥¨"],a:"éƒµç¥¨"}, {s:"æ•¸å­¸",q:"ç›´è§’å¹¾åº¦?",o:["90","60","45","180"],a:"90"}],
            high: [{s:"ç¤¾æœƒ",q:"ç«‹æ³•é™¢è² è²¬?",o:["ä¿®æ³•","æŠ“äºº","æ•‘ç«","è“‹æˆ¿"],a:"ä¿®æ³•"}, {s:"è‡ªç„¶",q:"äººé«”æœ€å¤§å™¨å®˜?",o:["çš®è†š","å¿ƒè‡Ÿ","è‚è‡Ÿ","è‚º"],a:"çš®è†š"}]
        },
        // Set C: è¶£å‘³å†·çŸ¥è­˜é¡Œ (ğŸ”´ å·²ä¿®å¾©é¸é …)
        {
            low: [{s:"è‡ªç„¶",q:"å…”å­æ„›åƒè‚‰ã€‚",a:false}, {s:"æ•¸å­¸",q:"æ™‚é˜æœ‰12å€‹æ•¸å­—ã€‚",a:true}, {s:"ç”Ÿæ´»",q:"éå¹´è¦é ˜ç´…åŒ…ã€‚",a:true}, {s:"è‹±æ–‡",q:"Redæ˜¯è—è‰²ã€‚",a:false}, {s:"åœ‹èª",q:"æ›¸çš„å–®ä½æ˜¯æœ¬ã€‚",a:true}],
            mid: [{s:"è‡ªç„¶",q:"é’è›™å°æ™‚å€™?",o:["èŒèšª","æ¯›æ¯›èŸ²","å°é­š","å­‘å­“"],a:"èŒèšª"}, {s:"æ•¸å­¸",q:"1å¤©å¹¾å°æ™‚?",o:["24","12","60","48"],a:"24"}],
            high: [{s:"æ­·å²",q:"åœ‹çˆ¶æ˜¯èª°?",o:["å­«ä¸­å±±","è”£ä¸­æ­£","æ—è‚¯","å­”å­"],a:"å­«ä¸­å±±"}, {s:"è‡ªç„¶",q:"æé¾çµ•ç¨®äº†å—?",o:["æ˜¯","å¦","é‚„æœ‰å¹¾éš»","åœ¨å‹•ç‰©åœ’"],a:"æ˜¯"}]
        },
        // Set D: é‚è¼¯èˆ‡é‹ç®—é¡Œ (ğŸ”´ å·²ä¿®å¾©é¸é …)
        {
            low: [{s:"æ•¸å­¸",q:"æ­£æ–¹å½¢å››é‚Šä¸€æ¨£é•·ã€‚",a:true}, {s:"ç”Ÿæ´»",q:"çœ‹åˆ°ç«ç½æ‰“110ã€‚",a:false}, {s:"è‡ªç„¶",q:"å¤ªé™½æ™šä¸Šä¼‘æ¯ã€‚",a:false}, {s:"è‹±æ–‡",q:"Oneæ˜¯1ã€‚",a:true}, {s:"åœ‹èª",q:"èŠ±æ˜¯æ¤ç‰©ã€‚",a:true}],
            mid: [{s:"æ•¸å­¸",q:"1å…¬é‡Œ=?å…¬å°º",o:["1000","100","10","500"],a:"1000"}, {s:"ç¤¾æœƒ",q:"ç«¯åˆç¯€åƒ?",o:["ç²½å­","æœˆé¤…","æ¹¯åœ“","è›‹ç³•"],a:"ç²½å­"}],
            high: [{s:"æ•¸å­¸",q:"0.5+0.5=?",o:["1","0.1","10","5"],a:"1"}, {s:"è‡ªç„¶",q:"å…‰åˆä½œç”¨éœ€è¦?",o:["é™½å…‰","æœˆå…‰","ç‡ˆå…‰","æ˜Ÿå…‰"],a:"é™½å…‰"}]
        },
        // Set E: æŒ‘æˆ°é¡Œ (ğŸ”´ å·²ä¿®å¾©é¸é …)
        {
            low: [{s:"æ•¸å­¸",q:"2å€‹5æ˜¯15ã€‚",a:false}, {s:"ç”Ÿæ´»",q:"åœ–æ›¸é¤¨å¯ä»¥è·‘æ­¥ã€‚",a:false}, {s:"è‡ªç„¶",q:"å†°æ˜¯ç†±çš„ã€‚",a:false}, {s:"è‹±æ–‡",q:"Bookæ˜¯æ›¸ã€‚",a:true}, {s:"åœ‹èª",q:"å³çš„ç›¸åæ˜¯å·¦ã€‚",a:true}],
            mid: [{s:"è‹±æ–‡",q:"Thank youæ˜¯?",o:["è¬è¬","å°ä¸èµ·","ä½ å¥½","å†è¦‹"],a:"è¬è¬"}, {s:"è‡ªç„¶",q:"ç£éµå¸ä»€éº¼?",o:["éµ","æœ¨é ­","å¡‘è† ","ç´™"],a:"éµ"}],
            high: [{s:"è‹±æ–‡",q:"Deliciousæ˜¯?",o:["ç¾å‘³","å±éšª","ç”Ÿæ°£","å¿«æ¨‚"],a:"ç¾å‘³"}, {s:"ç¤¾æœƒ",q:"ç›´è½„å¸‚æœ‰?",o:["é«˜é›„","åŸºéš†","æ–°ç«¹","å±æ±"],a:"é«˜é›„"}]
        }
    ];

    // ğŸ² éš¨æ©Ÿé¸æ“‡ä¸€å€‹å®‡å®™ (Set)
    const DB = UNIVERSE[Math.floor(Math.random() * UNIVERSE.length)];

    let state = { grade: '', score: 0, lives: 3, timer: 60, timerId: null, isOver: false, usedQ: [] };
    let currentQuestion = null;
    let usedQuestions = { low: [], mid: [], high: [] }; 

    function startGame(grade) {
        state.grade = grade;
        state.score = 0;
        state.isOver = false;
        
        document.getElementById('grade-menu').style.display = 'none';
        document.getElementById('game-interface').style.display = 'block';
        document.getElementById('score-val').innerText = 0;
        
        if (grade === 'low') {
            document.getElementById('grade-display').innerText = "ä½å¹´ç´šï¼é€£å°æŒ‘æˆ°";
            document.getElementById('score-label').innerText = "é€£å°:";
            document.getElementById('tf-panel').style.display = 'flex';
            document.getElementById('mcq-panel').style.display = 'none';
            document.getElementById('lives-container').style.display = 'none';
            document.getElementById('timer-bar-bg').style.display = 'none';
        } else if (grade === 'mid') {
            document.getElementById('grade-display').innerText = "ä¸­å¹´ç´šï¼é™æ™‚æŒ‘æˆ°";
            document.getElementById('score-label').innerText = "å¾—åˆ†:";
            document.getElementById('tf-panel').style.display = 'none';
            document.getElementById('mcq-panel').style.display = 'grid';
            document.getElementById('lives-container').style.display = 'none';
            document.getElementById('timer-bar-bg').style.display = 'block';
            startTimer();
        } else {
            document.getElementById('grade-display').innerText = "é«˜å¹´ç´šï¼ç©åˆ†æŒ‘æˆ°";
            document.getElementById('score-label').innerText = "å¾—åˆ†:";
            state.lives = 3;
            updateLives();
            document.getElementById('tf-panel').style.display = 'none';
            document.getElementById('mcq-panel').style.display = 'grid';
            document.getElementById('lives-container').style.display = 'inline';
            document.getElementById('timer-bar-bg').style.display = 'none';
        }

        nextQuestion();
    }

    function startTimer() {
        state.timer = 60;
        if(state.timerId) clearInterval(state.timerId);
        state.timerId = setInterval(() => {
            state.timer--;
            let pct = (state.timer / 60) * 100;
            document.getElementById('timer-bar-fill').style.width = pct + "%";
            if(state.timer <= 0) gameOver("æ™‚é–“åˆ°ï¼");
        }, 1000);
    }

    function updateLives() {
        let h = "";
        for(let i=0; i<state.lives; i++) h += "â¤ï¸";
        document.getElementById('lives-container').innerText = h;
    }

    function nextQuestion() {
        if(state.isOver) return;
        
        const pool = DB[state.grade];
        if (!pool || pool.length === 0) { alert("é¡Œåº«è¼‰å…¥éŒ¯èª¤"); return; }

        const used = usedQuestions[state.grade];

        if (used.length >= pool.length) {
            if(state.grade === 'low') gameOver("å¤ªå¼·äº†ï¼å…¨å°é€šé—œï¼");
            else { alert("æœ¬å€é¡Œç›®å…¨éƒ¨ç­”å®Œï¼å³å°‡é‡ç½®..."); usedQuestions[state.grade] = []; }
        }

        let randIdx;
        let safetyCounter = 0;
        do {
            randIdx = Math.floor(Math.random() * pool.length);
            safetyCounter++;
            if(safetyCounter > 100) break;
        } while (used.includes(randIdx));

        usedQuestions[state.grade].push(randIdx);
        currentQuestion = pool[randIdx];
        
        document.getElementById('subj-badge').innerText = currentQuestion.s;
        document.getElementById('q-text').innerText = currentQuestion.q;

        if (state.grade !== 'low') {
            const panel = document.getElementById('mcq-panel');
            panel.innerHTML = '';
            let opts = [...currentQuestion.o];
            opts.sort(() => Math.random() - 0.5);
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'mcq-btn';
                btn.innerText = opt;
                btn.onclick = () => checkAns(opt);
                panel.appendChild(btn);
            });
        }
    }

    function checkAns(ans) {
        if(state.isOver) return;
        let isCorrect = (ans === currentQuestion.a);
        showFeedback(isCorrect);

        if (isCorrect) {
            if(state.grade === 'low') state.score++; else state.score += 10;
            document.getElementById('score-val').innerText = state.score;
            setTimeout(nextQuestion, 600);
        } else {
            if (state.grade === 'low') gameOver("ç­”éŒ¯äº†ï¼æŒ‘æˆ°çµæŸ");
            else if (state.grade === 'mid') setTimeout(nextQuestion, 600);
            else { state.lives--; updateLives(); if(state.lives <= 0) gameOver("ç”Ÿå‘½è€—ç›¡ï¼"); else setTimeout(nextQuestion, 600); }
        }
    }

    function showFeedback(isCorrect) {
        const id = isCorrect ? 'fb-correct' : 'fb-wrong';
        const el = document.getElementById(id);
        el.style.display = 'block';
        el.style.animation = 'none';
        el.offsetHeight; 
        el.style.animation = 'popIn 0.5s';
        setTimeout(() => { el.style.display = 'none'; }, 600);
    }

    function gameOver(msg) {
        state.isOver = true;
        if(state.timerId) clearInterval(state.timerId);
        document.getElementById('result-modal').classList.add('active');
        document.getElementById('res-title').innerText = msg;
        let desc = "";
        if(state.grade === 'low') desc = `é€£å°ç´€éŒ„ï¼š`; else desc = `æœ€çµ‚å¾—åˆ†ï¼š`;
        document.getElementById('res-desc').innerText = desc;
        document.getElementById('res-score').innerText = state.score;
    }

    function submitScore() {
        const n = document.getElementById('input-name').value.trim();
        if(!n) { alert("è«‹è¼¸å…¥åå­—"); return; }
        fetch(API_URL, { method:'POST', body:JSON.stringify({type:'record', name:n, time:state.score, grade:state.grade}), headers:{"Content-Type":"text/plain"} })
        .then(r=>r.json()).then(d=>{ alert("âœ… ä¸Šå‚³æˆåŠŸ"); location.reload(); }).catch(e=>{ alert("ä¸Šå‚³å¤±æ•—"); });
    }

    function openRank() { document.getElementById('rank-modal').classList.add('active'); loadRank(state.grade || 'low'); }
    function loadRank(grade) {
        document.getElementById('rank-list').innerHTML = "è¼‰å…¥ä¸­...";
        fetch(API_URL + `?action=getRank&grade=${grade}&sort=desc`)
            .then(r=>r.json())
            .then(d=>{
                const div = document.getElementById('rank-list');
                div.innerHTML = "";
                if(d.length==0) div.innerHTML = '<div style="text-align:center; padding:20px;">å°šç„¡ç´€éŒ„</div>';
                d.slice(0,10).forEach((row,i) => {
                    let medal = i===0?'ğŸ¥‡':(i===1?'ğŸ¥ˆ':(i===2?'ğŸ¥‰':(i+1+'.')));
                    let unit = (grade === 'low') ? "é¡Œ" : "åˆ†";
                    div.innerHTML += `<div class="rank-row"><span>${medal} ${row.name}</span><span>${row.score}${unit}</span></div>`;
                });
            });
    }
</script>
</body>
</html>