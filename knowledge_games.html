<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‚‘ç‰¹ä½©çŸ¥è­˜æ®¿å ‚ V35</title>
    <style>
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; margin: 0; padding: 0; background: #000; color: #333; user-select: none; }

        /* èƒŒæ™¯ */
        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('bg_knowledge.jpg'); background-size: cover; background-position: center;
            filter: blur(3px) brightness(0.5); z-index: -1;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; padding-bottom: 100px; padding-top: 60px;
            box-sizing: border-box; position: relative; overflow-y: auto;
        }

        .header {
            position: absolute; top: 20px; width: 100%; text-align: center; color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8); z-index: 10;
        }
        .header h1 { margin: 0; font-size: 2.2rem; letter-spacing: 2px; }
        .header p { margin: 5px 0 0; color: #ddd; font-size: 0.9rem; }

        /* é¸å–® */
        #grade-menu {
            background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; width: 85%; max-width: 400px;
            border: 1px solid #fff; z-index: 20;
        }
        .g-btn {
            display: block; width: 100%; padding: 15px; margin: 15px 0;
            font-size: 1.3rem; font-weight: bold; border: none; border-radius: 50px;
            cursor: pointer; transition: 0.2s; color: white; box-shadow: 0 5px 0 rgba(0,0,0,0.2);
            text-align: left; padding-left: 30px;
        }
        .g-btn:active { transform: translateY(5px); box-shadow: none; }
        .g-btn span { font-size: 0.9rem; opacity: 0.8; display: block; font-weight: normal; margin-top: 5px;}
        .btn-low { background: linear-gradient(to right, #43a047, #66bb6a); }
        .btn-mid { background: linear-gradient(to right, #fb8c00, #ffb74d); }
        .btn-high { background: linear-gradient(to right, #1e88e5, #42a5f5); }

        /* éŠæˆ²å€ */
        #game-interface { display: none; width: 90%; max-width: 600px; animation: slideUp 0.5s; z-index: 20; }
        
        /* ç‹€æ…‹åˆ— (åˆ†æ•¸/æ™‚é–“/ç”Ÿå‘½) */
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.6); color: white; padding: 10px 20px;
            border-radius: 50px; margin-bottom: 15px; font-weight: bold; font-size: 1.2rem;
            border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px);
        }
        .status-icon { margin-right: 5px; }
        
        /* è¨ˆæ™‚æ¢ (ä¸­å¹´ç´š) */
        #timer-bar-bg { width: 100%; height: 8px; background: #555; border-radius: 4px; margin-top: 5px; overflow: hidden; display: none; }
        #timer-bar-fill { height: 100%; width: 100%; background: #fb8c00; transition: width 1s linear; }

        /* ç”Ÿå‘½å¿ƒå¿ƒ (é«˜å¹´ç´š) */
        #lives-container { color: #f44336; letter-spacing: 5px; display: none; }

        .quiz-card {
            background: #fff; border-radius: 20px; padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); text-align: center; position: relative;
            min-height: 220px; display: flex; flex-direction: column; justify-content: center;
            border: 4px solid #fff;
        }
        .subject-badge {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 5px 20px; border-radius: 20px;
            font-weight: bold; font-size: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .q-text { font-size: 1.6rem; font-weight: bold; line-height: 1.4; margin: 20px 0; color: #2c3e50; }
        
        /* O/X æŒ‰éˆ• */
        .tf-area { display: flex; gap: 30px; margin-top: 30px; justify-content: center; }
        .tf-btn {
            width: 90px; height: 90px; border-radius: 50%; border: 5px solid #fff;
            font-size: 2.5rem; font-weight: bold; cursor: pointer; color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.1s;
        }
        .tf-btn:active { transform: scale(0.9); }
        .btn-o { background: #43a047; } .btn-x { background: #e53935; }

        /* MCQ æŒ‰éˆ• */
        .mcq-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .mcq-btn {
            padding: 15px; font-size: 1.2rem; font-weight: bold; border: none;
            background: #fff; color: #333; border-radius: 12px;
            cursor: pointer; box-shadow: 0 4px 0 #ccc; border: 2px solid #eee;
            transition: 0.1s; min-height: 60px; display: flex; align-items: center; justify-content: center;
        }
        .mcq-btn:active { transform: translateY(4px); box-shadow: none; background: #eee; }

        /* çµç®—è¦–çª— */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100; flex-direction: column; backdrop-filter: blur(8px); }
        .modal.active { display: flex; animation: fadeIn 0.3s; } 
        .modal-box { background: #fff; padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; border: 5px solid #eee; }
        
        .rank-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #ddd; font-size: 1rem; color:#333; text-align:left; }
        
        /* å°èˆª */
        #jetpay-navbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; height: 65px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 50px; border: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999; } .nav-item { text-decoration: none; color: #95a5a6; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; transition: 0.2s; } .nav-icon { font-size: 1.6rem; margin-bottom: 2px; } .nav-item:hover { color: #2c3e50; transform: translateY(-2px); } .nav-item-special { color: #e67e22; font-weight: bold; } .nav-item-special .nav-icon { background: #e67e22; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(230, 126, 34, 0.4); margin-top: -20px; border: 4px solid white; }

        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .feedback-popup { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; z-index: 100; text-shadow: 0 5px 20px rgba(0,0,0,0.5); display: none; animation: popIn 0.5s; }
        @keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0); } 80% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1); } }
    </style>
</head>
<body>

<div id="bg-layer"></div>

<div class="header">
    <h1>çŸ¥è­˜æ®¿å ‚</h1>
    <p>æ™ºæ…§æ˜¯é€šå¾€æœªä¾†çš„é‘°åŒ™</p>
</div>

<div class="container">
    
    <div id="grade-menu">
        <h2 style="margin-top:0; color:#555;">è«‹é¸æ“‡æŒ‘æˆ°ç­‰ç´š</h2>
        <button class="g-btn btn-low" onclick="startGame('low')">
            ğŸ‘¶ ä½å¹´ç´š
            <span>ã€é€£å°ç‹ã€‘ä¸€é¡Œéƒ½ä¸èƒ½éŒ¯ï¼</span>
        </button>
        <button class="g-btn btn-mid" onclick="startGame('mid')">
            ğŸ‘¦ ä¸­å¹´ç´š
            <span>ã€é€Ÿè®€ç‹ã€‘é™æ™‚60ç§’æ¥µé€ŸæŒ‘æˆ°ï¼</span>
        </button>
        <button class="g-btn btn-high" onclick="startGame('high')">
            ğŸ§‘â€ğŸ“ é«˜å¹´ç´š
            <span>ã€ç©åˆ†ç‹ã€‘3æ¬¡å¤±èª¤æ©Ÿæœƒï¼Œç´¯ç©æœ€é«˜åˆ†ï¼</span>
        </button>
    </div>

    <div id="game-interface">
        
        <div class="status-bar">
            <div id="status-left"><span class="status-icon">ğŸ”°</span><span id="grade-display">ä½å¹´ç´š</span></div>
            <div id="status-right">
                <span id="score-label">åˆ†æ•¸:</span> <span id="score-val" style="color:#ffeb3b; font-size:1.4rem;">0</span>
                <span id="lives-container" style="margin-left:10px;">â¤ï¸â¤ï¸â¤ï¸</span>
            </div>
        </div>
        <div id="timer-bar-bg"><div id="timer-bar-fill"></div></div>

        <div class="quiz-card">
            <div class="subject-badge" id="subj-badge">ç§‘ç›®</div>
            <div class="q-text" id="q-text">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
        </div>

        <div id="tf-panel" class="tf-area" style="display:none;">
            <div class="tf-btn btn-o" onclick="checkAns(true)">O</div>
            <div class="tf-btn btn-x" onclick="checkAns(false)">X</div>
        </div>

        <div id="mcq-panel" class="mcq-area" style="display:none;"></div>
        
        <div style="text-align:center; margin-top:20px;">
            <button onclick="location.reload()" style="padding:10px 25px; background:rgba(0,0,0,0.5); color:fff; border:1px solid rgba(255,255,255,0.5); border-radius:20px; cursor:pointer;">æ”¾æ£„æŒ‘æˆ°</button>
        </div>
    </div>

</div>

<div class="modal" id="result-modal">
    <div class="modal-box">
        <h1 id="res-title" style="margin:0 0 10px 0;">æŒ‘æˆ°çµæŸ</h1>
        <p id="res-desc" style="color:#666;"></p>
        <h2 id="res-score" style="font-size:3rem; color:#f44336; margin:10px 0;">0</h2>
        <p style="color:#999; font-size:0.9rem;">è«‹è¼¸å…¥åå­—ä¸Šå‚³æ¦®è­½æ¦œ</p>
        <input type="text" id="input-name" placeholder="ä¾‹å¦‚: 301 å°æ˜" style="padding:10px; width:80%; font-size:1.1rem; text-align:center; border:2px solid #ddd; border-radius:10px;">
        <br><br>
        <button onclick="submitScore()" style="width:100%; padding:15px; background:#2196f3; color:white; border:none; border-radius:10px; font-size:1.2rem; cursor:pointer; font-weight:bold;">ä¸Šå‚³æˆç¸¾</button>
        <button onclick="location.reload()" style="width:100%; padding:10px; background:#ddd; color:#555; border:none; border-radius:10px; margin-top:10px; cursor:pointer;">å›é¦–é </button>
    </div>
</div>

<div class="modal" id="rank-modal">
    <div class="modal-box" style="height:70vh; display:flex; flex-direction:column;">
        <h2 style="margin:0 0 15px 0;">ğŸ† è‹±é›„æ¦œ</h2>
        <div class="rank-tabs">
            <button class="g-btn btn-low" style="padding:5px; text-align:center; font-size:0.9rem;" onclick="loadRank('low')">ä½å¹´ç´š</button>
            <button class="g-btn btn-mid" style="padding:5px; text-align:center; font-size:0.9rem;" onclick="loadRank('mid')">ä¸­å¹´ç´š</button>
            <button class="g-btn btn-high" style="padding:5px; text-align:center; font-size:0.9rem;" onclick="loadRank('high')">é«˜å¹´ç´š</button>
        </div>
        <div id="rank-list" style="flex:1; overflow-y:auto; margin-top:10px; border-top:1px solid #eee;">è¼‰å…¥ä¸­...</div>
        <button onclick="document.getElementById('rank-modal').classList.remove('active')" style="margin-top:10px; padding:10px; background:#ddd; border:none; border-radius:10px; cursor:pointer;">é—œé–‰</button>
    </div>
</div>

<div id="fb-correct" class="feedback-popup">âœ…</div>
<div id="fb-wrong" class="feedback-popup">âŒ</div>

<div id="jetpay-navbar">
    <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>é¦–é </span></a>
    <a href="simple_games.html" class="nav-item"><span class="nav-icon">ğŸ§©</span><span>ç°¡å–®</span></a>
    <a href="adventure_map.html" class="nav-item"><span class="nav-icon">ğŸ°</span><span>é—–é—œ</span></a>
    <a href="knowledge_games.html" class="nav-item nav-item-special"><span class="nav-icon">ğŸ“š</span><span>çŸ¥è­˜</span></a>
    <a href="#" class="nav-item" onclick="openRank()"><span class="nav-icon">ğŸ†</span><span>æ’è¡Œ</span></a>
</div>

<script>
    // ğŸ”´ ğŸ”´ ğŸ”´ è«‹æ›ä¸Šæ–°çš„ GAS ç¶²å€ (V5.0) ğŸ”´ ğŸ”´ ğŸ”´
    const API_URL = "https://script.google.com/macros/s/AKfycbwKUB2BPH1jD7ch2yenKSokuHq15ktPk1UfORI0RVNYVL6_oIBISNr27MX5Yng-7i-DqA/exec";

    // é¡Œåº« (DB å…§å®¹åŒä¸Šï¼Œç‚ºç¯€çœç¯‡å¹…çœç•¥ï¼Œè«‹ç›´æ¥ä½¿ç”¨ V2.0 çš„å®Œæ•´é¡Œåº«å…§å®¹)
    // è«‹å‹™å¿…æŠŠ V2.0 é‚£å€‹å¾ˆé•·çš„ DB è®Šæ•¸è¤‡è£½éä¾†é€™è£¡ï¼
    const DB = {
        low: [
            {s:"ç”Ÿæ´»", q:"ç´…ç‡ˆåœï¼Œç¶ ç‡ˆè¡Œã€‚", a:true}, {s:"ç”Ÿæ´»", q:"éé¦¬è·¯è¦åœ¨è»Šé™£ä¸­ç©¿æ¢­ã€‚", a:false},
            {s:"æ•¸å­¸", q:"5 + 5 = 10", a:true}, {s:"æ•¸å­¸", q:"ä¸‰è§’å½¢æœ‰ 4 å€‹è§’ã€‚", a:false},
            {s:"åœ‹èª", q:"ã€Œè˜‹æœã€æ˜¯æ°´æœã€‚", a:true}, {s:"åœ‹èª", q:"å¤ªé™½å¾è¥¿é‚Šå‡èµ·ã€‚", a:false},
            {s:"è‡ªç„¶", q:"å†°å¡ŠèåŒ–æœƒè®Šæˆæ°´ã€‚", a:true}, {s:"è‹±æ–‡", q:"Apple æ˜¯é¦™è•‰çš„æ„æ€ã€‚", a:false},
            {s:"ç”Ÿæ´»", q:"ç¡è¦ºå‰è¦åˆ·ç‰™ã€‚", a:true}, {s:"ç¤¾æœƒ", q:"æˆ‘å€‘ä½åœ¨æœˆçƒä¸Šã€‚", a:false},
            {s:"æ•¸å­¸", q:"10 æ¯” 8 å¤§ã€‚", a:true}, {s:"è‡ªç„¶", q:"é­šç”Ÿæ´»åœ¨æ°´è£¡ã€‚", a:true}
        ],
        mid: [
            {s:"ç¤¾æœƒ", q:"å°ç£çš„é¦–éƒ½åœ¨å“ªè£¡ï¼Ÿ", o:["å°åŒ—","é«˜é›„","å°ä¸­","å°å—"], a:"å°åŒ—"},
            {s:"æ•¸å­¸", q:"8 x 7 = ?", o:["56","48","64","54"], a:"56"},
            {s:"è‡ªç„¶", q:"ç£éµèƒ½å¸ä»€éº¼ï¼Ÿ", o:["éµé‡˜","æœ¨é ­","å¡‘è† ","ç´™"], a:"éµé‡˜"},
            {s:"åœ‹èª", q:"å®ˆæ ªå¾…__ï¼Ÿ", o:["å…”","è™","è±¬","é¾"], a:"å…”"},
            {s:"è‹±æ–‡", q:"Thank you çš„æ„æ€æ˜¯ï¼Ÿ", o:["è¬è¬","å°ä¸èµ·","ä½ å¥½","å†è¦‹"], a:"è¬è¬"},
            {s:"æ•¸å­¸", q:"1å…¬é‡Œç­‰æ–¼å¹¾å…¬å°ºï¼Ÿ", o:["1000","100","10","10000"], a:"1000"},
            {s:"è‡ªç„¶", q:"é’è›™å°æ™‚å€™å«ä»€éº¼ï¼Ÿ", o:["èŒèšª","æ¯›æ¯›èŸ²","å°é­š","å­‘å­“"], a:"èŒèšª"},
            {s:"ç¤¾æœƒ", q:"ç«¯åˆç¯€è¦åƒä»€éº¼ï¼Ÿ", o:["ç²½å­","æœˆé¤…","æ¹¯åœ“","è›‹ç³•"], a:"ç²½å­"}
        ],
        high: [
            {s:"æ•¸å­¸", q:"ä¸‰è§’å½¢å…§è§’å’Œæ˜¯å¹¾åº¦ï¼Ÿ", o:["180åº¦","360åº¦","90åº¦","100åº¦"], a:"180åº¦"},
            {s:"è‡ªç„¶", q:"æ¤ç‰©é€²è¡Œå…‰åˆä½œç”¨éœ€è¦ï¼Ÿ", o:["é™½å…‰","æœˆå…‰","æ˜Ÿå…‰","ç‡ˆå…‰"], a:"é™½å…‰"},
            {s:"ç¤¾æœƒ", q:"å°ç£æœ€é«˜çš„å±±æ˜¯ï¼Ÿ", o:["ç‰å±±","é›ªå±±","é˜¿é‡Œå±±","é™½æ˜å±±"], a:"ç‰å±±"},
            {s:"åœ‹èª", q:"å“ªä¸€å€‹å­—æœ‰éŒ¯ï¼Ÿ", o:["å†æ¥å†å‹µ","å†æ¥å†å²","é¥è€Œä¸æ¨","å …æŒåˆ°åº•"], a:"å†æ¥å†å‹µ"},
            {s:"è‹±æ–‡", q:"Delicious æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", o:["ç¾å‘³çš„","å±éšªçš„","ç”Ÿæ°£çš„","å¿«æ¨‚çš„"], a:"ç¾å‘³çš„"},
            {s:"æ•¸å­¸", q:"0.5 + 0.5 = ?", o:["1","0.55","0.1","10"], a:"1"},
            {s:"è‡ªç„¶", q:"æœˆäº®ç¹è‘—èª°è½‰ï¼Ÿ", o:["åœ°çƒ","å¤ªé™½","ç«æ˜Ÿ","é‡‘æ˜Ÿ"], a:"åœ°çƒ"},
            {s:"ç¤¾æœƒ", q:"ä¸‹åˆ—å“ªå€‹æ˜¯ç›´è½„å¸‚ï¼Ÿ", o:["é«˜é›„å¸‚","åŸºéš†å¸‚","æ–°ç«¹å¸‚","å˜‰ç¾©å¸‚"], a:"é«˜é›„å¸‚"}
        ]
    };

    // éŠæˆ²ç‹€æ…‹
    let state = { grade: '', score: 0, lives: 3, timer: 60, timerId: null, isOver: false, usedQ: [] };
    let currentQuestion = null;

    function startGame(grade) {
        state.grade = grade;
        state.score = 0;
        state.isOver = false;
        state.usedQ = [];
        
        // ä»‹é¢åˆå§‹åŒ–
        document.getElementById('grade-menu').style.display = 'none';
        document.getElementById('game-interface').style.display = 'block';
        document.getElementById('score-val').innerText = 0;
        
        // æ¨¡å¼è¨­å®š
        if (grade === 'low') {
            document.getElementById('grade-display').innerText = "ä½å¹´ç´šï¼é€£å°æŒ‘æˆ°";
            document.getElementById('score-label').innerText = "é€£å°:";
            document.getElementById('tf-panel').style.display = 'flex';
            document.getElementById('mcq-panel').style.display = 'none';
            document.getElementById('lives-container').style.display = 'none';
            document.getElementById('timer-bar-bg').style.display = 'none';
        } else if (grade === 'mid') {
            document.getElementById('grade-display').innerText = "ä¸­å¹´ç´šï¼é™æ™‚æŒ‘æˆ°";
            document.getElementById('score-label').innerText = "å¾—åˆ†:";
            document.getElementById('tf-panel').style.display = 'none';
            document.getElementById('mcq-panel').style.display = 'grid';
            document.getElementById('lives-container').style.display = 'none';
            document.getElementById('timer-bar-bg').style.display = 'block';
            startTimer();
        } else {
            document.getElementById('grade-display').innerText = "é«˜å¹´ç´šï¼ç©åˆ†æŒ‘æˆ°";
            document.getElementById('score-label').innerText = "å¾—åˆ†:";
            state.lives = 3;
            updateLives();
            document.getElementById('tf-panel').style.display = 'none';
            document.getElementById('mcq-panel').style.display = 'grid';
            document.getElementById('lives-container').style.display = 'inline';
            document.getElementById('timer-bar-bg').style.display = 'none';
        }

        nextQuestion();
    }

    function startTimer() {
        state.timer = 60;
        if(state.timerId) clearInterval(state.timerId);
        state.timerId = setInterval(() => {
            state.timer--;
            let pct = (state.timer / 60) * 100;
            document.getElementById('timer-bar-fill').style.width = pct + "%";
            if(state.timer <= 0) gameOver("æ™‚é–“åˆ°ï¼");
        }, 1000);
    }

    function updateLives() {
        let h = "";
        for(let i=0; i<state.lives; i++) h += "â¤ï¸";
        document.getElementById('lives-container').innerText = h;
    }

    function nextQuestion() {
        if(state.isOver) return;
        
        const pool = DB[state.grade];
        // é˜²é‡è¤‡é‚è¼¯
        let availableIdx = pool.map((_, i) => i).filter(i => !state.usedQ.includes(i));
        
        if (availableIdx.length === 0) {
            // é¡Œç›®ç”¨å®Œäº†
            if(state.grade === 'low') gameOver("æ­å–œï¼å…¨å°é€šé—œï¼"); // ä½å¹´ç´šå…¨å°ä¹Ÿæ˜¯çµæŸ
            else {
                alert("é¡Œç›®å…¨éƒ¨ç­”å®Œï¼é‡ç½®é¡Œç›®...");
                state.usedQ = [];
                availableIdx = pool.map((_, i) => i); // é‡ç½®å¾Œç¹¼çºŒ
            }
        }
        
        if (availableIdx.length > 0) {
            const randIdx = availableIdx[Math.floor(Math.random() * availableIdx.length)];
            state.usedQ.push(randIdx);
            currentQuestion = pool[randIdx];
            
            document.getElementById('subj-badge').innerText = currentQuestion.s;
            document.getElementById('q-text').innerText = currentQuestion.q;

            if (state.grade !== 'low') {
                const panel = document.getElementById('mcq-panel');
                panel.innerHTML = '';
                let opts = [...currentQuestion.o];
                opts.sort(() => Math.random() - 0.5);
                opts.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'mcq-btn';
                    btn.innerText = opt;
                    btn.onclick = () => checkAns(opt);
                    panel.appendChild(btn);
                });
            }
        }
    }

    function checkAns(ans) {
        if(state.isOver) return;
        let isCorrect = (ans === currentQuestion.a);
        
        showFeedback(isCorrect);

        if (isCorrect) {
            if(state.grade === 'low') state.score++; // é€£å°æ•¸+1
            else state.score += 10; // åˆ†æ•¸+10
            
            document.getElementById('score-val').innerText = state.score;
            setTimeout(nextQuestion, 600);
        } else {
            // ç­”éŒ¯é‚è¼¯
            if (state.grade === 'low') {
                gameOver("ç­”éŒ¯äº†ï¼æŒ‘æˆ°çµæŸ");
            } else if (state.grade === 'mid') {
                // ä¸­å¹´ç´šä¸æ‰£åˆ†ï¼Œåªæµªè²»æ™‚é–“
                setTimeout(nextQuestion, 600);
            } else {
                // é«˜å¹´ç´šæ‰£è¡€
                state.lives--;
                updateLives();
                if(state.lives <= 0) gameOver("ç”Ÿå‘½è€—ç›¡ï¼");
                else setTimeout(nextQuestion, 600);
            }
        }
    }

    function showFeedback(isCorrect) {
        const id = isCorrect ? 'fb-correct' : 'fb-wrong';
        const el = document.getElementById(id);
        el.style.display = 'block';
        el.style.animation = 'none';
        el.offsetHeight; 
        el.style.animation = 'popIn 0.5s';
        setTimeout(() => { el.style.display = 'none'; }, 600);
    }

    function gameOver(msg) {
        state.isOver = true;
        if(state.timerId) clearInterval(state.timerId);
        
        document.getElementById('result-modal').classList.add('active');
        document.getElementById('res-title').innerText = msg;
        
        let desc = "";
        if(state.grade === 'low') desc = `ä½ çš„é€£å°ç´€éŒ„ï¼š`;
        else desc = `æœ€çµ‚å¾—åˆ†ï¼š`;
        
        document.getElementById('res-desc').innerText = desc;
        document.getElementById('res-score').innerText = state.score;
    }

    function submitScore() {
        const n = document.getElementById('input-name').value.trim();
        if(!n) { alert("è«‹è¼¸å…¥åå­—"); return; }
        
        // ä½å¹´ç´šå‚³é€£å°æ•¸ï¼Œä¸­é«˜å¹´ç´šå‚³åˆ†æ•¸
        // è¨˜å¾—ï¼šGAS V5.0 å·²ç¶“è¨­å®š knowledge sort=desc (ç”±å¤§åˆ°å°)ï¼Œæ‰€ä»¥ä¸ç®¡æ˜¯é€£å°æ•¸é‚„æ˜¯åˆ†æ•¸ï¼Œéƒ½æ˜¯è¶Šé«˜è¶Šå¥½ï¼Œé‚è¼¯é€šï¼
        fetch(API_URL, { 
            method:'POST', 
            body:JSON.stringify({type:'record', name:n, time:state.score, grade:state.grade}), // æ³¨æ„é€™è£¡ç”¨ time æ¬„ä½å‚³ score
            headers:{"Content-Type":"text/plain"} 
        })
        .then(r=>r.json()).then(d=>{ alert("âœ… ä¸Šå‚³æˆåŠŸ"); location.reload(); })
        .catch(e=>{ alert("ä¸Šå‚³å¤±æ•—"); });
    }

    function openRank() { document.getElementById('rank-modal').classList.add('active'); loadRank(state.grade || 'low'); }
    
    function loadRank(grade) {
        document.getElementById('rank-list').innerHTML = "è¼‰å…¥ä¸­...";
        // ğŸ”´ é—œéµï¼šåŠ ä¸Š &sort=desc åƒæ•¸ï¼Œå‘Šè¨´ GAS é€™æ˜¯è¦æ¯”åˆ†æ•¸é«˜ (é™åº)
        fetch(API_URL + `?action=getRank&grade=${grade}&sort=desc`)
            .then(r=>r.json())
            .then(d=>{
                const div = document.getElementById('rank-list');
                div.innerHTML = "";
                if(d.length==0) div.innerHTML = '<div style="text-align:center; padding:20px;">å°šç„¡ç´€éŒ„</div>';
                d.slice(0,10).forEach((row,i) => {
                    let medal = i===0?'ğŸ¥‡':(i===1?'ğŸ¥ˆ':(i===2?'ğŸ¥‰':(i+1+'.')));
                    // æ ¹æ“šå¹´ç´šé¡¯ç¤ºä¸åŒå–®ä½
                    let unit = (grade === 'low') ? "é¡Œ" : "åˆ†";
                    div.innerHTML += `<div class="rank-row"><span>${medal} ${row.name}</span><span>${row.score}${unit}</span></div>`;
                });
            });
    }
</script>
</body>
</html>