<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çŸ¥è­˜æ®¿å ‚ V38.5 (æœ€çµ‚å®Œæ•´ç‰ˆ)</title>
    <style>
        /* === æ ¸å¿ƒæ¨£å¼ (é»‘é‡‘æ®¿å ‚é¢¨) === */
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; margin: 0; padding: 0; background: #1a1a1a; color: #333; user-select: none; overflow-x: hidden; }
        #bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%); z-index: -1; }
        
        /* å°èˆªèˆ‡æ¨™é¡Œ */
        header { position: absolute; top: 0; width: 100%; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 10; }
        .home-btn { text-decoration: none; color: white; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-weight: bold; backdrop-filter: blur(5px); }
        .header-title { color: white; font-size: 1.5rem; text-shadow: 0 2px 5px rgba(0,0,0,0.5); font-weight: bold; margin: 0 auto; transform: translateX(-40px); }

        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 60px 20px; box-sizing: border-box; }
        
        /* é¸å–®å€ */
        #grade-menu { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 0 50px rgba(255,215,0,0.1); text-align: center; width: 100%; max-width: 400px; animation: fadeIn 0.5s; }
        .g-btn { display: block; width: 100%; padding: 15px; margin: 15px 0; font-size: 1.3rem; font-weight: bold; border: none; border-radius: 15px; cursor: pointer; transition: 0.2s; color: white; text-align: left; padding-left: 20px; position: relative; overflow: hidden; }
        .g-btn span { font-size: 0.85rem; opacity: 0.9; display: block; font-weight: normal; margin-top: 3px; }
        .g-btn:active { transform: scale(0.98); }
        .btn-low { background: linear-gradient(135deg, #4caf50, #81c784); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
        .btn-mid { background: linear-gradient(135deg, #ff9800, #ffb74d); box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4); }
        .btn-high { background: linear-gradient(135deg, #2196f3, #64b5f6); box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4); }
        
        /* éŠæˆ²ä»‹é¢ */
        #game-interface { display: none; width: 100%; max-width: 600px; animation: slideUp 0.5s; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); color: white; padding: 10px 20px; border-radius: 50px; margin-bottom: 15px; font-weight: bold; font-size: 1.2rem; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px); }
        #lives-container { color: #f44336; letter-spacing: 2px; margin-left: 10px; }
        #timer-bar-bg { width: 100%; height: 6px; background: #444; border-radius: 4px; margin-bottom: 15px; overflow: hidden; display: none; }
        #timer-bar-fill { height: 100%; width: 100%; background: #fb8c00; transition: width 1s linear; }
        
        /* é¡Œç›®å¡ç‰‡ */
        .quiz-card { background: #fff; border-radius: 20px; padding: 30px 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center; position: relative; min-height: 200px; display: flex; flex-direction: column; justify-content: center; }
        .subject-badge { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 5px 20px; border-radius: 20px; font-weight: bold; font-size: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .q-text { font-size: 1.8rem; font-weight: bold; line-height: 1.4; color: #2c3e50; }
        
        /* é¸é …æŒ‰éˆ• */
        .tf-area { display: flex; gap: 20px; margin-top: 30px; justify-content: center; }
        .tf-btn { width: 80px; height: 80px; border-radius: 50%; font-size: 2.5rem; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.1s; border: 4px solid white; }
        .tf-btn:active { transform: scale(0.9); }
        .btn-o { background: #4caf50; } .btn-x { background: #f44336; }
        
        .mcq-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .mcq-btn { padding: 15px; font-size: 1.1rem; font-weight: bold; border: none; background: #fff; color: #333; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 0 #ccc; border: 2px solid #eee; transition: 0.1s; min-height: 70px; display: flex; align-items: center; justify-content: center; }
        .mcq-btn:active { transform: translateY(4px); box-shadow: none; background: #e0e0e0; }
        
        /* å½ˆçª— */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100; flex-direction: column; backdrop-filter: blur(8px); }
        .modal.active { display: flex; animation: fadeIn 0.3s; } 
        .modal-box { background: #fff; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 5px solid #444; }
        
        /* æ’è¡Œæ¦œ */
        .rank-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #ddd; font-size: 1rem; color:#333; text-align:left; }
        .rank-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .rt-btn { flex: 1; padding: 8px; border: none; background: #eee; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .rt-btn.active { background: #333; color: white; }

        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } 
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } 
        .feedback-popup { position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; z-index: 50; text-shadow: 0 5px 20px rgba(0,0,0,0.5); display: none; pointer-events: none; }
    </style>
</head>
<body>

<div id="bg-layer"></div>

<header>
    <a href="index.html" class="home-btn">ğŸ  å›é¦–é </a>
    <div class="header-title">çŸ¥è­˜æ®¿å ‚</div>
    <div style="width: 80px;"></div> 
</header>

<div class="container">
    <div id="grade-menu">
        <h2 style="margin-top:0; color:#555;">è«‹é¸æ“‡æŒ‘æˆ°ç­‰ç´š</h2>
        <button class="g-btn btn-low" onclick="startGame('low')">ğŸ‘¶ ä½å¹´ç´š (1-2å¹´ç´š)<span>ã€é€£å°ç‹ã€‘ä¸€é¡Œéƒ½ä¸èƒ½éŒ¯ï¼</span></button>
        <button class="g-btn btn-mid" onclick="startGame('mid')">ğŸ‘¦ ä¸­å¹´ç´š (3-4å¹´ç´š)<span>ã€é€Ÿè®€ç‹ã€‘é™æ™‚ 60 ç§’æŒ‘æˆ°ï¼</span></button>
        <button class="g-btn btn-high" onclick="startGame('high')">ğŸ§‘â€ğŸ“ é«˜å¹´ç´š (5-6å¹´ç´š)<span>ã€ç©åˆ†ç‹ã€‘3 æ¬¡å¤±èª¤æ©Ÿæœƒï¼</span></button>
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
            <button onclick="openRank()" style="background:transparent; border:1px solid #ccc; padding:8px 20px; border-radius:20px; cursor:pointer; color:#555;">ğŸ† æŸ¥çœ‹è‹±é›„æ¦œ</button>
            <button onclick="clearHistory()" style="background:transparent; border:1px solid #f44336; padding:8px 20px; border-radius:20px; cursor:pointer; color:#f44336; margin-left:10px;">ğŸ—‘ï¸ é‡ç½®é¡Œåº«ç´€éŒ„</button>
        </div>
    </div>
    
    <div id="game-interface">
        <div class="status-bar">
            <div id="status-left"><span id="grade-display">ç­‰ç´š</span></div>
            <div id="status-right">
                <span id="score-label">åˆ†æ•¸:</span> 
                <span id="score-val" style="color:#ffeb3b; font-size:1.4rem;">0</span>
                <span id="lives-container">â¤ï¸â¤ï¸â¤ï¸</span>
            </div>
        </div>
        <div id="timer-bar-bg"><div id="timer-bar-fill"></div></div>
        
        <div class="quiz-card">
            <div class="subject-badge" id="subj-badge">ç§‘ç›®</div>
            <div class="q-text" id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
        </div>
        
        <div id="tf-panel" class="tf-area" style="display:none;">
            <div class="tf-btn btn-o" onclick="checkAns(true)">O</div>
            <div class="tf-btn btn-x" onclick="checkAns(false)">X</div>
        </div>
        
        <div id="mcq-panel" class="mcq-area" style="display:none;"></div>
        
        <div style="text-align:center; margin-top:30px;">
            <button onclick="location.reload()" style="padding:8px 20px; background:rgba(255,255,255,0.2); color:#aaa; border:none; border-radius:20px; cursor:pointer;">æ”¾æ£„æŒ‘æˆ°</button>
        </div>
    </div>
</div>

<div class="modal" id="result-modal">
    <div class="modal-box">
        <h1 id="res-title" style="margin:0 0 10px 0;">æŒ‘æˆ°çµæŸ</h1>
        <p id="res-desc" style="color:#666;"></p>
        <h2 id="res-score" style="font-size:3rem; color:#f44336; margin:10px 0;">0</h2>
        <p style="color:#999; font-size:0.9rem;">è¼¸å…¥åå­—ï¼Œå°‡æ¦®è€€åˆ»åœ¨æ®¿å ‚ä¸Šï¼</p>
        <input type="text" id="input-name" placeholder="ä¾‹å¦‚: 301 å°æ˜" style="padding:12px; width:80%; font-size:1.1rem; text-align:center; border:2px solid #ddd; border-radius:10px;"><br><br>
        <button onclick="submitScore()" style="width:100%; padding:15px; background:#2196f3; color:white; border:none; border-radius:10px; font-size:1.2rem; cursor:pointer; font-weight:bold; box-shadow:0 4px 0 #1976d2;">ä¸Šå‚³æˆç¸¾</button>
        <button onclick="location.reload()" style="width:100%; padding:10px; background:#eee; color:#555; border:none; border-radius:10px; margin-top:10px; cursor:pointer;">å›é¦–é </button>
    </div>
</div>

<div class="modal" id="rank-modal">
    <div class="modal-box" style="height:70vh; display:flex; flex-direction:column;">
        <h2 style="margin:0 0 15px 0;">ğŸ† çŸ¥è­˜è‹±é›„æ¦œ</h2>
        <div class="rank-tabs">
            <button class="rt-btn active" onclick="loadRank('low', this)">ä½å¹´ç´š</button>
            <button class="rt-btn" onclick="loadRank('mid', this)">ä¸­å¹´ç´š</button>
            <button class="rt-btn" onclick="loadRank('high', this)">é«˜å¹´ç´š</button>
        </div>
        <div id="rank-list" style="flex:1; overflow-y:auto; margin-top:10px; border-top:1px solid #eee;">è¼‰å…¥ä¸­...</div>
        <button onclick="document.getElementById('rank-modal').classList.remove('active')" style="margin-top:10px; padding:10px; background:#ddd; border:none; border-radius:10px; cursor:pointer;">é—œé–‰</button>
    </div>
</div>

<div id="fb-correct" class="feedback-popup">âœ…</div>
<div id="fb-wrong" class="feedback-popup">âŒ</div>

<script>
    // ğŸ”´ GAS V6.5 ç¶²å€ (è«‹ç¢ºèªä¸€è‡´)
    const API_URL = "https://script.google.com/macros/s/AKfycbwKUB2BPH1jD7ch2yenKSokuHq15ktPk1UfORI0RVNYVL6_oIBISNr27MX5Yng-7i-DqA/exec";

    // === V38: äº”é‡å¹³è¡Œå®‡å®™é¡Œåº« (Set A ~ E) ===
    // æ¯å€‹ç­‰ç´šè‡³å°‘ 5 é¡Œï¼Œç¢ºä¿æœ‰è¶³å¤ é¡Œç›®è¼ªæ›¿
    const UNIVERSE = [
        // Set A
        {
            low: [{id:"A1",s:"ç”Ÿæ´»",q:"ç´…ç‡ˆåœï¼Œç¶ ç‡ˆè¡Œã€‚",a:true}, {id:"A2",s:"æ•¸å­¸",q:"5+5=10",a:true}, {id:"A3",s:"è‡ªç„¶",q:"é­šåœ¨æ°´è£¡æ¸¸",a:true}, {id:"A4",s:"è‹±æ–‡",q:"Appleæ˜¯è˜‹æœ",a:true}, {id:"A5",s:"åœ‹èª",q:"å¤§å°å°",a:true}],
            mid: [{id:"AM1",s:"ç¤¾æœƒ",q:"é¦–éƒ½åœ¨å°åŒ—",o:["å°åŒ—","å°ä¸­","é«˜é›„","å°å—"],a:"å°åŒ—"}, {id:"AM2",s:"æ•¸å­¸",q:"8x7=?",o:["56","48","64","54"],a:"56"}, {id:"AM3",s:"è‡ªç„¶",q:"é’è›™å°æ™‚å€™æ˜¯?",o:["èŒèšª","æ¯›æ¯›èŸ²","å°é­š","è®Šè‰²é¾"],a:"èŒèšª"}, {id:"AM4",s:"è‹±æ–‡",q:"Thank youæ˜¯?",o:["è¬è¬","å°ä¸èµ·","å†è¦‹","ä½ å¥½"],a:"è¬è¬"}, {id:"AM5",s:"åœ‹èª",q:"ä¸€__é©šäºº",o:["é³´","å","æ°‘","æ˜"],a:"é³´"}],
            high: [{id:"AH1",s:"ç¤¾æœƒ",q:"æœ€é«˜å³°æ˜¯?",o:["ç‰å±±","é›ªå±±","é˜¿é‡Œå±±","é™½æ˜å±±"],a:"ç‰å±±"}, {id:"AH2",s:"è‡ªç„¶",q:"å¤ªé™½ç³»æœ€å¤§?",o:["æœ¨æ˜Ÿ","åœŸæ˜Ÿ","åœ°çƒ","ç«æ˜Ÿ"],a:"æœ¨æ˜Ÿ"}, {id:"AH3",s:"æ•¸å­¸",q:"0.5+0.5=?",o:["1","0.1","10","5"],a:"1"}, {id:"AH4",s:"æ­·å²",q:"åœ‹çˆ¶æ˜¯èª°?",o:["å­«ä¸­å±±","è”£ä¸­æ­£","æ—è‚¯","å­”å­"],a:"å­«ä¸­å±±"}, {id:"AH5",s:"è‹±æ–‡",q:"Deliciousæ˜¯?",o:["ç¾å‘³","å±éšª","ç”Ÿæ°£","å¿«æ¨‚"],a:"ç¾å‘³"}]
        },
        // Set B
        {
            low: [{id:"B1",s:"ç”Ÿæ´»",q:"å—å‚·è¦å»è­¦å¯Ÿå±€ã€‚",a:false}, {id:"B2",s:"æ•¸å­¸",q:"10å…ƒæ›5å€‹1å…ƒã€‚",a:false}, {id:"B3",s:"è‡ªç„¶",q:"ä¸‹é›¨æœƒæœ‰å½©è™¹ã€‚",a:true}, {id:"B4",s:"è‹±æ–‡",q:"Dogæ˜¯è²“ã€‚",a:false}, {id:"B5",s:"åœ‹èª",q:"ç­†æ˜¯ç”¨ä¾†å¯«å­—ã€‚",a:true}],
            mid: [{id:"BM1",s:"ç¤¾æœƒ",q:"å¯„ä¿¡ç”¨ä»€éº¼?",o:["éƒµç¥¨","è»Šç¥¨","ç™¼ç¥¨","éˆ”ç¥¨"],a:"éƒµç¥¨"}, {id:"BM2",s:"æ•¸å­¸",q:"ç›´è§’å¹¾åº¦?",o:["90","60","45","180"],a:"90"}, {id:"BM3",s:"è‡ªç„¶",q:"æœˆäº®ç¹åœ°çƒè½‰",o:["æ˜¯","å¦","ä¸ä¸€å®š","çœ‹å¿ƒæƒ…"],a:"æ˜¯"}, {id:"BM4",s:"åœ‹èª",q:"å®ˆæ ªå¾…__",o:["å…”","è™","è±¬","é¾"],a:"å…”"}, {id:"BM5",s:"è‹±æ–‡",q:"Bookæ˜¯?",o:["æ›¸","ç­†","æ¡Œå­","æ¤…å­"],a:"æ›¸"}],
            high: [{id:"BH1",s:"ç¤¾æœƒ",q:"ç«‹æ³•é™¢è² è²¬?",o:["ä¿®æ³•","æŠ“äºº","æ•‘ç«","è“‹æˆ¿"],a:"ä¿®æ³•"}, {id:"BH2",s:"è‡ªç„¶",q:"äººé«”æœ€å¤§å™¨å®˜?",o:["çš®è†š","å¿ƒè‡Ÿ","è‚è‡Ÿ","è‚º"],a:"çš®è†š"}, {id:"BH3",s:"æ•¸å­¸",q:"ä¸‰è§’å½¢å…§è§’å’Œ?",o:["180","360","90","100"],a:"180"}, {id:"BH4",s:"è‹±æ–‡",q:"Hospitalæ˜¯?",o:["é†«é™¢","å­¸æ ¡","é£¯åº—","éŠ€è¡Œ"],a:"é†«é™¢"}, {id:"BH5",s:"åœ‹èª",q:"èª‡é£¾æ³•ä¾‹å­?",o:["ç™½é«®ä¸‰åƒä¸ˆ","èŠ±å…’ç¬‘äº†","å¤©æ°£å¾ˆå¥½","ä»–è·‘å¾ˆå¿«"],a:"ç™½é«®ä¸‰åƒä¸ˆ"}]
        },
        // Set C
        {
            low: [{id:"C1",s:"è‡ªç„¶",q:"å…”å­æ„›åƒè‚‰ã€‚",a:false}, {id:"C2",s:"æ•¸å­¸",q:"æ™‚é˜æœ‰12å€‹æ•¸å­—ã€‚",a:true}, {id:"C3",s:"ç”Ÿæ´»",q:"éå¹´è¦é ˜ç´…åŒ…ã€‚",a:true}, {id:"C4",s:"è‹±æ–‡",q:"Redæ˜¯è—è‰²ã€‚",a:false}, {id:"C5",s:"åœ‹èª",q:"æ›¸çš„å–®ä½æ˜¯æœ¬ã€‚",a:true}],
            mid: [{id:"CM1",s:"è‡ªç„¶",q:"å…‰åˆä½œç”¨éœ€è¦?",o:["é™½å…‰","æœˆå…‰","ç‡ˆå…‰","æ˜Ÿå…‰"],a:"é™½å…‰"}, {id:"CM2",s:"æ•¸å­¸",q:"1å¤©å¹¾å°æ™‚?",o:["24","12","60","48"],a:"24"}, {id:"CM3",s:"è‹±æ–‡",q:"Libraryæ˜¯?",o:["åœ–æ›¸é¤¨","å­¸æ ¡","å…¬åœ’","é†«é™¢"],a:"åœ–æ›¸é¤¨"}, {id:"CM4",s:"ç¤¾æœƒ",q:"ç«¯åˆç¯€åƒ?",o:["ç²½å­","æœˆé¤…","æ¹¯åœ“","è›‹ç³•"],a:"ç²½å­"}, {id:"CM5",s:"åœ‹èª",q:"å†æ¥å†__",o:["å²","å‹µ","åŠ›","åˆ©"],a:"å²"}],
            high: [{id:"CH1",s:"æ­·å²",q:"é„­æˆåŠŸè¶•èµ°?",o:["è·è˜­äºº","è¥¿ç­ç‰™äºº","æ—¥æœ¬äºº","æ³•åœ‹äºº"],a:"è·è˜­äºº"}, {id:"CH2",s:"è‡ªç„¶",q:"æé¾çµ•ç¨®äº†å—?",o:["æ˜¯","å¦","é‚„æœ‰å¹¾éš»","åœ¨å‹•ç‰©åœ’"],a:"æ˜¯"}, {id:"CH3",s:"æ•¸å­¸",q:"åœ“å‘¨ç‡ç´„ç‚º?",o:["3.14","3.41","3.12","3.00"],a:"3.14"}, {id:"CH4",s:"è‹±æ–‡",q:"Elephantæ˜¯?",o:["å¤§è±¡","ç…å­","è€è™","çŒ´å­"],a:"å¤§è±¡"}, {id:"CH5",s:"ç¤¾æœƒ",q:"å°ç£æœ€é•·æ²³?",o:["æ¿æ°´æºª","é«˜å±æºª","æ·¡æ°´æ²³","å¤§ç”²æºª"],a:"æ¿æ°´æºª"}]
        },
        // Set D
        {
            low: [{id:"D1",s:"æ•¸å­¸",q:"æ­£æ–¹å½¢å››é‚Šä¸€æ¨£é•·ã€‚",a:true}, {id:"D2",s:"ç”Ÿæ´»",q:"çœ‹åˆ°ç«ç½æ‰“110ã€‚",a:false}, {id:"D3",s:"è‡ªç„¶",q:"å¤ªé™½æ™šä¸Šä¼‘æ¯ã€‚",a:false}, {id:"D4",s:"è‹±æ–‡",q:"Oneæ˜¯1ã€‚",a:true}, {id:"D5",s:"åœ‹èª",q:"èŠ±æ˜¯æ¤ç‰©ã€‚",a:true}],
            mid: [{id:"DM1",s:"æ•¸å­¸",q:"1å…¬é‡Œ=?å…¬å°º",o:["1000","100","10","500"],a:"1000"}, {id:"DM2",s:"ç¤¾æœƒ",q:"åŸä½æ°‘ç¥­å…¸?",o:["è±å¹´ç¥­","æ½‘æ°´ç¯€","è¬è–ç¯€","è–èª•ç¯€"],a:"è±å¹´ç¥­"}, {id:"DM3",s:"è‡ªç„¶",q:"æ˜†èŸ²å¹¾éš»è…³?",o:["6","4","8","10"],a:"6"}, {id:"DM4",s:"è‹±æ–‡",q:"Beautifulæ˜¯?",o:["ç¾éº—","é†œé™‹","ç”Ÿæ°£","å¿«æ¨‚"],a:"ç¾éº—"}, {id:"DM5",s:"åœ‹èª",q:"ç›¸åè©:å¤§å°?",o:["å°","å¤š","å°‘","é«˜"],a:"å°"}],
            high: [{id:"DH1",s:"æ•¸å­¸",q:"1å…¬å™¸=?å…¬æ–¤",o:["1000","100","10","10000"],a:"1000"}, {id:"DH2",s:"è‡ªç„¶",q:"ç©ºæ°£æœ€å¤šæ°£é«”?",o:["æ°®æ°£","æ°§æ°£","äºŒæ°§åŒ–ç¢³","æ°«æ°£"],a:"æ°®æ°£"}, {id:"DH3",s:"è‹±æ–‡",q:"Yesterdayæ˜¯?",o:["æ˜¨å¤©","ä»Šå¤©","æ˜å¤©","å¾Œå¤©"],a:"æ˜¨å¤©"}, {id:"DH4",s:"ç¤¾æœƒ",q:"è¡Œæ”¿é™¢é•·æ˜¯?",o:["ä»»å‘½åˆ¶","é¸èˆ‰åˆ¶","ä¸–è¥²åˆ¶","è€ƒè©¦åˆ¶"],a:"ä»»å‘½åˆ¶"}, {id:"DH5",s:"åœ‹èª",q:"è†¾ç‚™äººå£è®€éŸ³?",o:["ã„ã„¨ã„Ë‹","ã„ã„¨ã„ŸË‹","ã„ã„¨ã„ŸË‹","ã„ã„¨ã„ŸË‹"],a:"ã„ã„¨ã„Ë‹"}]
        },
        // Set E
        {
            low: [{id:"E1",s:"æ•¸å­¸",q:"2å€‹5æ˜¯15ã€‚",a:false}, {id:"E2",s:"ç”Ÿæ´»",q:"åœ–æ›¸é¤¨å¯ä»¥è·‘æ­¥ã€‚",a:false}, {id:"E3",s:"è‡ªç„¶",q:"å†°æ˜¯ç†±çš„ã€‚",a:false}, {id:"E4",s:"è‹±æ–‡",q:"Bookæ˜¯æ›¸ã€‚",a:true}, {id:"E5",s:"åœ‹èª",q:"å³çš„ç›¸åæ˜¯å·¦ã€‚",a:true}],
            mid: [{id:"EM1",s:"è‹±æ–‡",q:"Brotheræ˜¯?",o:["å…„å¼Ÿ","å§å¦¹","çˆ¶æ¯","è€å¸«"],a:"å…„å¼Ÿ"}, {id:"EM2",s:"è‡ªç„¶",q:"ç£éµå¸ä»€éº¼?",o:["éµ","æœ¨é ­","å¡‘è† ","ç´™"],a:"éµ"}, {id:"EM3",s:"æ•¸å­¸",q:"45 / 5 = ?",o:["9","8","7","6"],a:"9"}, {id:"EM4",s:"ç¤¾æœƒ",q:"éé¦¬è·¯èµ°?",o:["æ–‘é¦¬ç·š","å¿«è»Šé“","å±‹é ‚","æ°´æº"],a:"æ–‘é¦¬ç·š"}, {id:"EM5",s:"åœ‹èª",q:"å“ªå€‹å­—æ˜¯æ°´æœ?",o:["æ¢¨","åŠ›","åˆ©","é›¢"],a:"æ¢¨"}],
            high: [{id:"EH1",s:"è‹±æ–‡",q:"Airportæ˜¯?",o:["æ©Ÿå ´","æ¸¯å£","è»Šç«™","å…¬åœ’"],a:"æ©Ÿå ´"}, {id:"EH2",s:"ç¤¾æœƒ",q:"ç›´è½„å¸‚æœ‰?",o:["é«˜é›„","åŸºéš†","æ–°ç«¹","å±æ±"],a:"é«˜é›„"}, {id:"EH3",s:"æ•¸å­¸",q:"25 x 4 = ?",o:["100","90","110","120"],a:"100"}, {id:"EH4",s:"è‡ªç„¶",q:"æ§“æ¡¿åŸç†æ”¯é»åœ¨ä¸­é–“?",o:["è¹ºè¹ºæ¿","é–‹ç“¶å™¨","éºµåŒ…å¤¾","é‡£é­šç«¿"],a:"è¹ºè¹ºæ¿"}, {id:"EH5",s:"åœ‹èª",q:"ä¸€æ—¥ä¸‰ç§‹å½¢å®¹?",o:["æ€å¿µ","å¾ˆå¿«","ç§‹å¤©","å¾ˆè€"],a:"æ€å¿µ"}]
        }
    ];

    // === æ ¸å¿ƒè®Šæ•¸ ===
    let currentDBIndex = 0; 
    let state = { grade: '', score: 0, lives: 3, timer: 60, timerId: null, isOver: false };
    let currentQuestion = null;
    
    // === LocalStorage ç´€éŒ„å·²åšé¡Œç›® ===
    const STORAGE_KEY = "jeatpei_quiz_history"; 

    function getHistory() {
        const history = localStorage.getItem(STORAGE_KEY);
        return history ? JSON.parse(history) : [];
    }

    function saveHistory(questionId) {
        let history = getHistory();
        if (!history.includes(questionId)) {
            history.push(questionId);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }
    }

    function clearHistory() {
        localStorage.removeItem(STORAGE_KEY);
        alert("ç´€éŒ„å·²é‡ç½®ï¼æ‰€æœ‰é¡Œç›®å°‡é‡æ–°å‡ºç¾ã€‚");
        location.reload();
    }

    // === éŠæˆ²é–‹å§‹ ===
    function startGame(grade) {
        state.grade = grade;
        state.score = 0;
        state.isOver = false;
        
        // éš¨æ©Ÿé¸ä¸€å€‹å¹³è¡Œå®‡å®™ (0~4)
        currentDBIndex = Math.floor(Math.random() * UNIVERSE.length);
        console.log(`[ç³»çµ±] é€²å…¥ç¬¬ ${currentDBIndex} è™Ÿå¹³è¡Œå®‡å®™`);

        document.getElementById('grade-menu').style.display = 'none';
        document.getElementById('game-interface').style.display = 'block';
        document.getElementById('score-val').innerText = 0;
        
        // ä»‹é¢åˆå§‹åŒ–
        if (grade === 'low') {
            document.getElementById('grade-display').innerText = "ä½å¹´ç´šï¼é€£å°æŒ‘æˆ°";
            document.getElementById('score-label').innerText = "é€£å°:";
            document.getElementById('tf-panel').style.display = 'flex';
            document.getElementById('mcq-panel').style.display = 'none';
            document.getElementById('lives-container').style.display = 'none';
            document.getElementById('timer-bar-bg').style.display = 'none';
        } else if (grade === 'mid') {
            document.getElementById('grade-display').innerText = "ä¸­å¹´ç´šï¼é™æ™‚æŒ‘æˆ°";
            document.getElementById('score-label').innerText = "å¾—åˆ†:";
            document.getElementById('tf-panel').style.display = 'none';
            document.getElementById('mcq-panel').style.display = 'grid';
            document.getElementById('lives-container').style.display = 'none';
            document.getElementById('timer-bar-bg').style.display = 'block';
            startTimer();
        } else {
            document.getElementById('grade-display').innerText = "é«˜å¹´ç´šï¼ç©åˆ†æŒ‘æˆ°";
            document.getElementById('score-label').innerText = "å¾—åˆ†:";
            state.lives = 3;
            updateLives();
            document.getElementById('tf-panel').style.display = 'none';
            document.getElementById('mcq-panel').style.display = 'grid';
            document.getElementById('lives-container').style.display = 'inline';
            document.getElementById('timer-bar-bg').style.display = 'none';
        }
        nextQuestion();
    }

    function startTimer() {
        state.timer = 60;
        if(state.timerId) clearInterval(state.timerId);
        state.timerId = setInterval(() => {
            state.timer--;
            let pct = (state.timer / 60) * 100;
            document.getElementById('timer-bar-fill').style.width = pct + "%";
            if(state.timer <= 0) gameOver("æ™‚é–“åˆ°ï¼");
        }, 1000);
    }

    function updateLives() {
        let h = "";
        for(let i=0; i<state.lives; i++) h += "â¤ï¸";
        document.getElementById('lives-container').innerText = h;
    }

    // === ğŸ”¥ é—œéµï¼šé¸é¡Œé‚è¼¯ (ä¸é‡è¤‡) ===
    function nextQuestion() {
        if(state.isOver) return;
        
        const pool = UNIVERSE[currentDBIndex][state.grade];
        const history = getHistory(); 

        // 1. éæ¿¾å‡ºã€Œé‚„æ²’åšéã€çš„é¡Œç›®
        const availableQuestions = pool.filter(q => !history.includes(q.id));

        // 2. æª¢æŸ¥æœ¬å®‡å®™é¡Œç›®æ˜¯å¦ç”¨å®Œ
        if (availableQuestions.length === 0) {
            // å˜—è©¦å»åˆ¥çš„å®‡å®™æ‰¾
            for(let i=0; i<UNIVERSE.length; i++) {
                const otherPool = UNIVERSE[i][state.grade];
                const otherAvailable = otherPool.filter(q => !history.includes(q.id));
                if(otherAvailable.length > 0) {
                    currentDBIndex = i; // åˆ‡æ›å®‡å®™
                    console.log(`[ç³»çµ±] åˆ‡æ›è‡³ ${i} è™Ÿå®‡å®™`);
                    nextQuestion(); 
                    return;
                }
            }

            // å…¨éƒ¨å®‡å®™éƒ½æ²’é¡Œäº†
            gameOver("å¤ªå¼·äº†ï¼å…¨å°é€šé—œï¼(é¡Œåº«å·²å…¨æ•¸å®Œæˆ)");
            return;
        }

        // 3. éš¨æ©ŸæŠ½é¸
        const randIdx = Math.floor(Math.random() * availableQuestions.length);
        currentQuestion = availableQuestions[randIdx];
        
        document.getElementById('subj-badge').innerText = currentQuestion.s;
        document.getElementById('q-text').innerText = currentQuestion.q;

        if (state.grade !== 'low') {
            const panel = document.getElementById('mcq-panel');
            panel.innerHTML = '';
            let opts = [...currentQuestion.o];
            opts.sort(() => Math.random() - 0.5); 
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'mcq-btn';
                btn.innerText = opt;
                btn.onclick = () => checkAns(opt);
                panel.appendChild(btn);
            });
        }
    }

    function checkAns(ans) {
        if(state.isOver) return;
        let isCorrect = (ans === currentQuestion.a);
        showFeedback(isCorrect);

        // è¨˜éŒ„é€™é¡Œåšéäº†
        saveHistory(currentQuestion.id);

        if (isCorrect) {
            if(state.grade === 'low') state.score++; else state.score += 10;
            document.getElementById('score-val').innerText = state.score;
            setTimeout(nextQuestion, 600);
        } else {
            if (state.grade === 'low') {
                gameOver("ç­”éŒ¯äº†ï¼æŒ‘æˆ°çµæŸ");
            } else if (state.grade === 'mid') {
                setTimeout(nextQuestion, 600); 
            } else { 
                state.lives--; 
                updateLives(); 
                if(state.lives <= 0) gameOver("ç”Ÿå‘½è€—ç›¡ï¼"); 
                else setTimeout(nextQuestion, 600); 
            }
        }
    }

    function showFeedback(isCorrect) {
        const id = isCorrect ? 'fb-correct' : 'fb-wrong';
        const el = document.getElementById(id);
        el.style.display = 'block';
        el.style.animation = 'none';
        el.offsetHeight; 
        el.style.animation = 'popIn 0.5s'; 
        setTimeout(() => { el.style.display = 'none'; }, 600);
    }

    function gameOver(msg) {
        if (state.isOver) return;
        state.isOver = true;
        if(state.timerId) clearInterval(state.timerId);
        
        document.getElementById('result-modal').classList.add('active');
        document.getElementById('res-title').innerText = msg;
        
        let desc = (state.grade === 'low') ? `é€£å°ç´€éŒ„ï¼š` : `æœ€çµ‚å¾—åˆ†ï¼š`;
        document.getElementById('res-desc').innerText = desc;
        document.getElementById('res-score').innerText = state.score;
    }

    function submitScore() {
        const n = document.getElementById('input-name').value.trim();
        if(!n) { alert("è«‹è¼¸å…¥åå­—"); return; }
        
        const btn = document.querySelector('#result-modal button');
        btn.disabled = true; btn.innerText = "ä¸Šå‚³ä¸­...";

        fetch(API_URL, { 
            method:'POST', 
            body:JSON.stringify({game:'knowledge', name:n, grade:state.grade, score:state.score}), 
            headers:{"Content-Type":"text/plain"} 
        })
        .then(r=>r.json())
        .then(d=>{ alert("âœ… ä¸Šå‚³æˆåŠŸ"); location.reload(); })
        .catch(e=>{ alert("ä¸Šå‚³å¤±æ•—"); btn.disabled = false; });
    }

    function openRank() { document.getElementById('rank-modal').classList.add('active'); loadRank(state.grade || 'low'); }
    
    function loadRank(grade, btn) {
        if(btn) { document.querySelectorAll('.rt-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        document.getElementById('rank-list').innerHTML = '<div style="text-align:center; padding:20px;">è³‡æ–™è®€å–ä¸­...</div>';
        
        fetch(API_URL + `?action=getRank&game=knowledge&sort=desc&grade=${grade}`)
            .then(r=>r.json())
            .then(d=>{
                const div = document.getElementById('rank-list');
                div.innerHTML = "";
                if(d.length==0) div.innerHTML = '<div style="text-align:center; padding:20px;">å°šç„¡ç´€éŒ„</div>';
                d.forEach((row,i) => {
                    let medal = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] || (i+1)+'.';
                    let unit = (grade === 'low') ? "é¡Œ" : "åˆ†";
                    div.innerHTML += `<div class="rank-row"><span>${medal} ${row.name}</span><span>${row.score}${unit}</span></div>`;
                });
            })
            .catch(e => {
                document.getElementById('rank-list').innerHTML = '<div style="text-align:center; padding:20px;">è®€å–å¤±æ•—</div>';
            });
    }
</script>
</body>
</html>