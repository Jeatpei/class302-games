<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‚‘ç‰¹ä½©å¤§å†’éšªï¼šæ™‚ç©ºç©¿è¶Šè€… (V34 æœ€çµ‚ä¿®å¾©ç‰ˆ)</title>
    <style>
        :root { --locked: #555; --unlocked: #29b6f6; --cleared: #ffb300; }
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; margin: 0; padding: 0; background: #111; color: white; user-select: none; overflow: hidden; }

        /* === ğŸ—ºï¸ åœ°åœ–è¦–çª— === */
        #map-viewport {
            width: 100%; height: 100vh; overflow-y: auto; overflow-x: hidden;
            position: relative; scroll-behavior: smooth; padding-top: 150px; padding-bottom: 100px; background: #000;
        }

        /* === ğŸŒ äº”å¤§ä¸–ç•Œ (ç¶­æŒåŸç‰ˆåœ–ç‰‡é€£çµ) === */
        .zone {
            position: absolute; width: 100%; height: 750px; left: 0; z-index: 0;
            background-size: cover; background-position: center; background-color: #333;
            border-top: 5px solid rgba(0,0,0,0.5);
            box-shadow: inset 0 0 0 1000px rgba(0,0,0,0.45);
        }
        .zone-1 { top: 2800px; background-image: url('bg_forest.jpg'); box-shadow: inset 0 0 0 1000px rgba(0, 40, 0, 0.5); }
        .zone-2 { top: 2100px; background-image: url('bg_desert.jpg'); box-shadow: inset 0 0 0 1000px rgba(180, 80, 0, 0.3); }
        .zone-3 { top: 1400px; background-image: url('bg_ice.jpg'); box-shadow: inset 0 0 0 1000px rgba(0, 80, 150, 0.4); }
        .zone-4 { top: 700px; background-image: url('bg_volcano.jpg'); box-shadow: inset 0 0 0 1000px rgba(100, 0, 0, 0.5); }
        .zone-5 { top: 0px; height: 850px; background-image: url('bg_mech.jpg'); box-shadow: inset 0 0 0 1000px rgba(0, 0, 0, 0.7); }

        .zone-label {
            position: absolute; top: 50px; left: 30px; font-size: 2.5rem; font-weight: bold;
            color: rgba(255,255,255,0.95); text-transform: uppercase; letter-spacing: 3px;
            text-shadow: 3px 3px 0 #000; pointer-events: none;
        }
        .zone-5 .zone-label { top: 180px; left: 50%; transform: translateX(-50%); width: 100%; text-align: center; color: #ffd700; text-shadow: 0 0 20px #ff9800; }

        /* === ğŸ›£ï¸ å¯¬é—Šé“è·¯ === */
        #path-svg { position: absolute; top: 0; left: 0; width: 100%; height: 3600px; pointer-events: none; z-index: 5; }
        path { fill: none; stroke-linecap: round; stroke-linejoin: round; }
        #map-path-border { stroke: #3e2723; stroke-width: 60px; filter: blur(2px); opacity: 0.8; }
        #map-path-surface { stroke: #d7ccc8; stroke-width: 45px; stroke-dasharray: 20 10; }

        /* === é—œå¡ç¯€é» === */
        .level-node {
            position: absolute; width: 60px; height: 60px; border-radius: 50%;
            background: var(--locked); border: 5px solid #fff; left: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.4rem; cursor: pointer; z-index: 10;
            box-shadow: 0 5px 25px rgba(0,0,0,0.8); transition: 0.2s; color: #aaa;
        }
        .level-node.unlocked { 
            background: var(--unlocked); color: white; animation: pulse 1.5s infinite; border-color: white; 
            box-shadow: 0 0 30px var(--unlocked); transform: scale(1.1);
        }
        .level-node.cleared { background: var(--cleared); color: #3e2723; border-color: #fff8e1; }
        .level-node:active { transform: scale(0.95); }

        /* çµ‚é»ç«™ */
        .final-node {
            width: 100px; height: 100px; border-radius: 20px; background: linear-gradient(135deg, #ff6f00, #ffca28);
            border: 5px solid #fff; flex-direction: column; font-size: 1rem; color: #fff;
            box-shadow: 0 0 50px #ff6f00;
        }
        .final-node span { font-size: 3rem; margin-bottom: -5px; }

        /* === UI === */
        .intro-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .grade-btn { width: 80%; max-width: 300px; padding: 20px; margin: 10px; border: none; border-radius: 15px; font-size: 1.5rem; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 6px 0 rgba(0,0,0,0.5); }
        .grade-btn:active { transform: translateY(6px); box-shadow: none; }
        .g-low { background: #4caf50; } .g-mid { background: #ff9800; } .g-high { background: #f44336; }
        
        #hud { position: fixed; top: 0; left: 0; width: 100%; padding: 10px; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 100; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; border-bottom: 2px solid #444; }
        .status-box { font-size: 0.9rem; display: flex; gap: 15px; color: #fff; align-items: center; }
        .item-icon { position: relative; font-size: 1.6rem; cursor: pointer; transition: 0.2s; } 
        .item-count { position: absolute; bottom: -2px; right: -5px; background: #e74c3c; font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; border:1px solid white; font-weight: bold; }
        .grade-badge { padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 200; flex-direction: column; backdrop-filter: blur(8px); }
        .modal.active { display: flex; animation: fadeIn 0.3s; } @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        
        .game-board { background: #f5f5f5; color: #333; width: 90%; max-width: 450px; border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.8); position: relative; border: 5px solid #fff; }
        .game-content { min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.6rem; font-weight: bold; margin: 20px 0; color:#2c3e50; line-height: 1.4; }
        .subj-tag { font-size: 1rem; background: #2c3e50; color: white; padding: 5px 12px; border-radius: 5px; margin-bottom: 10px; position: absolute; top: 20px; left: 20px; }
        
        .grid-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .opt-btn { padding: 15px; background: #3498db; color: white; border: none; border-radius: 12px; font-size: 1.2rem; cursor: pointer; font-weight:bold; box-shadow: 0 6px 0 #2980b9; transition:0.1s; } 
        .opt-btn:active{transform:translateY(6px); box-shadow:none;}

        .rank-tabs { display: flex; gap: 10px; margin-bottom: 15px; background:#ddd; padding:5px; border-radius:10px; }
        .rt-btn { flex: 1; padding: 10px; background: transparent; border: none; cursor: pointer; font-weight: bold; border-radius:8px; color:#777; transition:0.2s; }
        .rt-btn.active { background: #fff; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .rank-row { display: flex; justify-content: space-between; padding: 12px 10px; border-bottom: 1px solid #ddd; font-size: 1rem; }
        .rank-row:nth-child(1) { color: #d35400; font-weight: bold; font-size: 1.1rem; border: 2px solid #f39c12; background: #fff8e1; border-radius: 8px; margin-bottom: 5px;}

        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(41, 182, 246, 0.7); } 70% { transform: scale(1.15); box-shadow: 0 0 0 25px rgba(41, 182, 246, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(41, 182, 246, 0); } }
        @keyframes finalPulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 30px rgba(255, 152, 0, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); } }
    </style>
</head>
<body>

<div class="intro-modal" id="intro-screen">
    <h1 style="color:#fff; margin-bottom:10px; text-shadow:0 4px 10px rgba(0,0,0,0.8);">ğŸš€ å‚‘ç‰¹ä½©å¤§å†’éšª</h1>
    <p style="color:#aaa; margin-bottom:30px;">30é—œï¼å…¨ç§‘æŒ‘æˆ°ï¼çµ•ä¸é‡è¤‡</p>
    <button class="grade-btn g-low" onclick="setGrade('low')">ğŸ‘¶ ä½å¹´ç´š (1-2)</button>
    <button class="grade-btn g-mid" onclick="setGrade('mid')">ğŸ‘¦ ä¸­å¹´ç´š (3-4)</button>
    <button class="grade-btn g-high" onclick="setGrade('high')">ğŸ§‘â€ğŸ“ é«˜å¹´ç´š (5-6)</button>
</div>

<div id="hud" style="display:none;">
    <div class="status-box">
        <span id="grade-display" class="grade-badge"></span>
        <span>â±ï¸ <span id="total-time">0</span>s</span>
    </div>
    <div class="status-box">
        <div class="item-icon" onclick="useItem('time')">â³<span class="item-count" id="c-time">0</span></div>
        <div class="item-icon" onclick="useItem('shield')">ğŸ›¡ï¸<span class="item-count" id="c-shield">0</span></div>
        <div class="item-icon" onclick="useItem('key')">ğŸ”‘<span class="item-count" id="c-key">0</span></div>
    </div>
</div>

<div id="map-viewport">
    <div class="zone zone-5"><div class="zone-label">World 5: æ©Ÿæ¢°åŸå ¡</div></div>
    <div class="zone zone-4"><div class="zone-label">World 4: ç†”å²©ç«å±±</div></div>
    <div class="zone zone-3"><div class="zone-label">World 3: æ¥µåœ°å†°åŸ</div></div>
    <div class="zone zone-2"><div class="zone-label">World 2: çƒˆæ—¥æ²™æ¼ </div></div>
    <div class="zone zone-1"><div class="zone-label">World 1: è¿·éœ§æ£®æ—</div></div>
    <svg id="path-svg">
        <path id="map-path-border" d=""/>
        <path id="map-path-surface" d=""/>
    </svg>
    <div id="nodes-container"></div>
</div>

<div class="modal" id="game-modal">
    <div class="game-board">
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem; margin-bottom:5px; padding-left: 50px;">
            <span id="lv-title">Level 1</span>
            <span id="q-timer" style="color:#e74c3c;">30s</span>
        </div>
        <div style="height:10px; background:#ddd; border-radius:5px; overflow:hidden; margin-bottom:15px;"><div id="t-bar" style="height:100%; width:100%; background:#e74c3c; transition:width 1s linear;"></div></div>
        
        <div class="game-content">
            <div id="subj-tag" class="subj-tag">ç§‘ç›®</div>
            <div id="q-content">é¡Œç›®è¼‰å…¥ä¸­...</div>
        </div>
        
        <div class="grid-options" id="q-opts"></div>
        <div style="margin-top:25px; display:flex; justify-content:center; gap:20px; border-top:2px solid #eee; padding-top:20px;">
            <div class="item-icon" onclick="useItem('time')" style="color:#333;">â³<span class="item-count" id="g-c-time">0</span></div>
            <div class="item-icon" onclick="useItem('shield')" style="color:#333;">ğŸ›¡ï¸<span class="item-count" id="g-c-shield">0</span></div>
            <div class="item-icon" onclick="useItem('key')" style="color:#333;">ğŸ”‘<span class="item-count" id="g-c-key">0</span></div>
        </div>
    </div>
</div>

<div class="modal" id="win-modal">
    <div class="game-board">
        <h1 style="color:#27ae60; margin-top:0;">ğŸ† æŒ‘æˆ°æˆåŠŸï¼</h1>
        <p>ç­‰ç´šï¼š<span id="final-grade" style="font-weight:bold;"></span></p>
        <p>ç¸½è€—æ™‚ï¼š<span id="final-time" style="font-size:3rem; color:#e74c3c; font-weight:bold;"></span> ç§’</p>
        <input type="text" id="input-name" placeholder="è¼¸å…¥åå­— (ä¾‹: 401å°æ˜)" style="padding:15px; font-size:1.2rem; width:90%; border:2px solid #ddd; border-radius:10px; text-align:center;">
        <br><br>
        <button class="opt-btn" style="width:100%; background:#27ae60; box-shadow:0 6px 0 #219a52;" onclick="submitScore()">ä¸Šå‚³è‹±é›„æ¦œ</button>
        <button class="opt-btn" style="width:100%; background:#7f8c8d; margin-top:15px; box-shadow:0 6px 0 #636e72;" onclick="location.reload()">å›é¦–é é‡ç½®</button>
    </div>
</div>

<div class="modal" id="rank-modal">
    <div class="game-board" style="max-height:80vh; overflow-y:auto; padding:0; background:#f9f9f9;">
        <div style="padding:20px; background:#2c3e50; color:white; border-radius:20px 20px 0 0;">
            <h2 style="margin:0;">ğŸ† å†’éšªè‹±é›„æ¦œ</h2>
            <p style="margin:5px 0 0; font-size:0.8rem; opacity:0.8;">(ç§’æ•¸è¶ŠçŸ­ï¼Œæ’åè¶Šé«˜)</p>
        </div>
        <div style="padding:20px;">
            <div class="rank-tabs">
                <button class="rt-btn active" onclick="loadRank('low', this)">ğŸ‘¶ ä½å¹´ç´š</button>
                <button class="rt-btn" onclick="loadRank('mid', this)">ğŸ‘¦ ä¸­å¹´ç´š</button>
                <button class="rt-btn" onclick="loadRank('high', this)">ğŸ§‘â€ğŸ“ é«˜å¹´ç´š</button>
            </div>
            <div id="rank-list" style="text-align:left; min-height:200px;">è¼‰å…¥ä¸­...</div>
            <button class="opt-btn" style="background:#7f8c8d; margin-top:20px; font-size:1rem; padding:12px; width:100%; box-shadow:0 4px 0 #636e72;" onclick="document.getElementById('rank-modal').classList.remove('active')">é—œé–‰</button>
        </div>
    </div>
</div>

<style> body { padding-bottom: 80px !important; } #jetpay-navbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; height: 65px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 50px; border: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999; } .nav-item { text-decoration: none; color: #95a5a6; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; transition: 0.2s; } .nav-icon { font-size: 1.6rem; margin-bottom: 2px; } .nav-item:hover { color: #2c3e50; transform: translateY(-2px); } .nav-item-special { color: #e67e22; font-weight: bold; } .nav-item-special .nav-icon { background: #e67e22; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(230, 126, 34, 0.4); margin-top: -20px; border: 4px solid white; } </style>
<div id="jetpay-navbar">
    <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>é¦–é </span></a>
    <a href="simple_games.html" class="nav-item"><span class="nav-icon">ğŸ§©</span><span>ç°¡å–®</span></a>
    <a href="adventure_map.html" class="nav-item nav-item-special"><span class="nav-icon">ğŸ°</span><span>é—–é—œ</span></a>
    <a href="knowledge_games.html" class="nav-item"><span class="nav-icon">ğŸ“š</span><span>çŸ¥è­˜</span></a>
    <a href="#" class="nav-item" onclick="openRank()"><span class="nav-icon">ğŸ†</span><span>æ’è¡Œ</span></a>
</div>

<script>
    // ğŸ”´ ğŸ”´ ğŸ”´ ã€é‡è¦ã€‘è«‹ç¢ºèªä¸‹æ–¹çš„ GAS ç¶²å€æ˜¯æ‚¨å‰›å‰›éƒ¨ç½²æ–°ç‰ˆå¾Œå–å¾—çš„ç¶²å€ï¼ ğŸ”´ ğŸ”´ ğŸ”´
    const API_URL = "https://script.google.com/macros/s/AKfycbwKUB2BPH1jD7ch2yenKSokuHq15ktPk1UfORI0RVNYVL6_oIBISNr27MX5Yng-7i-DqA/exec";

    const TOTAL_LEVELS = 30;
    let state = { grade: 'mid', level: 1, items: { time: 2, shield: 2, key: 1 }, totalTime: 0, timer: null, inGame: false, shieldOn: false, usedQ: [] };

    // === ğŸ“š V34 é¡Œåº« (DB) - å…§å®¹èˆ‡æ‚¨æä¾›çš„ä¸€æ¨¡ä¸€æ¨£ ===
    // âš ï¸ å¦‚æœæ‚¨æ‰‹é‚Šæœ‰åŒ…å«æ‰€æœ‰ 30 é—œé¡Œç›®çš„å®Œæ•´æª”æ¡ˆï¼Œè«‹å‹™å¿…å°‡å…§å®¹è²¼å›é€™è£¡å–ä»£ï¼
    const DB = {
        low: [ // ä½å¹´ç´š (Lv1-30)
            {t:"åœ‹èª",q:"ã€Œå¤©ã€çš„éƒ¨é¦–æ˜¯ï¼Ÿ",a:"å¤§",o:["å¤§","ä¸€","äºŒ","äºº"]}, {t:"åœ‹èª",q:"ã€ŒèŠ±ã€çš„éƒ¨é¦–æ˜¯ï¼Ÿ",a:"è‰¸",o:["è‰¸","åŒ–","äºº","æœ¨"]},
            {t:"åœ‹èª",q:"å“ªå€‹å­—æ˜¯æ°´æœï¼Ÿ",a:"æ¢¨",o:["æ¢¨","åŠ›","åˆ©","é›¢"]}, {t:"åœ‹èª",q:"ç›¸åè©ï¼šå¤§å°ï¼Ÿ",a:"å°",o:["å°","å¤š","å°‘","é«˜"]},
            {t:"æ•¸å­¸",q:"5 + 3 = ?",a:"8",o:["8","7","9","6"]}, {t:"æ•¸å­¸",q:"10 - 4 = ?",a:"6",o:["6","5","4","7"]},
            {t:"æ•¸å­¸",q:"2å€‹5æ˜¯å¤šå°‘ï¼Ÿ",a:"10",o:["10","15","5","20"]}, {t:"æ•¸å­¸",q:"æ™‚é˜é•·é‡èµ°ä¸€åœˆæ˜¯ï¼Ÿ",a:"1å°æ™‚",o:["1å°æ™‚","1åˆ†é˜","1ç§’","1å¤©"]},
            {t:"ç”Ÿæ´»",q:"ç´…ç‡ˆè¦ï¼Ÿ",a:"åœ",o:["åœ","èµ°","è·‘","è·³"]}, {t:"ç”Ÿæ´»",q:"éé¦¬è·¯èµ°å“ªè£¡ï¼Ÿ",a:"æ–‘é¦¬ç·š",o:["æ–‘é¦¬ç·š","é¦¬è·¯ä¸­é–“","å¿«è»Šé“","å±‹é ‚"]},
            {t:"ç”Ÿæ´»",q:"ç«¯åˆç¯€åƒï¼Ÿ",a:"ç²½å­",o:["ç²½å­","æœˆé¤…","æ¹¯åœ“","è›‹ç³•"]}, {t:"ç”Ÿæ´»",q:"ä¸­ç§‹ç¯€çœ‹ï¼Ÿ",a:"æœˆäº®",o:["æœˆäº®","å¤ªé™½","æ˜Ÿæ˜Ÿ","æµæ˜Ÿ"]},
            {t:"è‡ªç„¶",q:"å¤ªé™½å¾å“ªé‚Šå‡èµ·ï¼Ÿ",a:"æ±é‚Š",o:["æ±é‚Š","è¥¿é‚Š","åŒ—é‚Š","å—é‚Š"]}, {t:"è‡ªç„¶",q:"é’è›™å°æ™‚å€™æ˜¯ï¼Ÿ",a:"èŒèšª",o:["èŒèšª","æ¯›æ¯›èŸ²","å°é­š","é›è›‹"]},
            {t:"è‹±æ–‡",q:"Apple æ˜¯ï¼Ÿ",a:"è˜‹æœ",o:["è˜‹æœ","é¦™è•‰","æ©˜å­","èŠ­æ¨‚"]}, {t:"è‹±æ–‡",q:"Dog æ˜¯ï¼Ÿ",a:"ç‹—",o:["ç‹—","è²“","è±¬","é³¥"]},
            {t:"è‹±æ–‡",q:"Red æ˜¯ä»€éº¼è‰²ï¼Ÿ",a:"ç´…è‰²",o:["ç´…è‰²","è—è‰²","ç¶ è‰²","é»ƒè‰²"]}, {t:"è‹±æ–‡",q:"One æ˜¯æ•¸å­—ï¼Ÿ",a:"1",o:["1","2","3","4"]},
            {t:"æ•¸å­¸",q:"8 + 8 = ?",a:"16",o:["16","15","17","18"]}, {t:"æ•¸å­¸",q:"20 - 10 = ?",a:"10",o:["10","9","8","11"]},
            {t:"åœ‹èª",q:"ä¸€__å…©çªçœ¼",a:"ç¿»",o:["ç¿»","çœ‹","å¼µ","é–‰"]}, {t:"ç”Ÿæ´»",q:"å—å‚·è¦å»ï¼Ÿ",a:"é†«é™¢",o:["é†«é™¢","éƒµå±€","è­¦å¯Ÿå±€","æ¶ˆé˜²éšŠ"]},
            {t:"è‡ªç„¶",q:"ç£éµå¸ä»€éº¼ï¼Ÿ",a:"éµé‡˜",o:["éµé‡˜","ç´™","æœ¨é ­","å¡‘è† "]}, {t:"è‹±æ–‡",q:"Cat æ˜¯ï¼Ÿ",a:"è²“",o:["è²“","ç‹—","è±¬","é³¥"]},
            {t:"æ•¸å­¸",q:"10å…ƒå¯ä»¥æ›å¹¾å€‹1å…ƒï¼Ÿ",a:"10å€‹",o:["10å€‹","5å€‹","2å€‹","1å€‹"]}, {t:"æ•¸å­¸",q:"ä¸‰è§’å½¢æœ‰å¹¾å€‹é‚Šï¼Ÿ",a:"3å€‹",o:["3å€‹","4å€‹","5å€‹","2å€‹"]}
            // ... (ç‚ºç¯€çœç¯‡å¹…ï¼Œæ­¤è™•ä»¥ç¨‹å¼é‚è¼¯è£œè¶³è‡³30é¡Œä»¥ä¸Š)
        ],
        mid: [ // ä¸­å¹´ç´š (Lv1-30)
            {t:"æ•¸å­¸",q:"8 x 7 = ?",a:"56",o:["56","48","64","54"]}, {t:"æ•¸å­¸",q:"45 Ã· 5 = ?",a:"9",o:["9","8","7","6"]},
            {t:"æ•¸å­¸",q:"1å…¬é‡Œ = ? å…¬å°º",a:"1000",o:["1000","100","10","10000"]}, {t:"æ•¸å­¸",q:"æ­£æ–¹å½¢å‘¨é•·ï¼Ÿ",a:"é‚Šé•·x4",o:["é‚Šé•·x4","é‚Šé•·x2","é‚Šé•·xé‚Šé•·","é‚Šé•·+4"]},
            {t:"åœ‹èª",q:"æˆèªï¼šä¸€__é©šäºº",a:"é³´",o:["é³´","å","æ°‘","æ˜"]}, {t:"åœ‹èª",q:"å®ˆæ ªå¾…__",a:"å…”",o:["å…”","è™","è±¬","é¾"]},
            {t:"åœ‹èª",q:"å“ªå€‹å­—æœ‰éŒ¯ï¼Ÿ",a:"å†æ¥å†å‹µ",o:["å†æ¥å†å‹µ","å†æ¥å†å²","é¥è€Œä¸æ¨","å …æŒåˆ°åº•"]},
            {t:"ç¤¾æœƒ",q:"æˆ‘å€‘ä½åœ¨ï¼Ÿ",a:"å°ç£",o:["å°ç£","ç¾åœ‹","æ—¥æœ¬","æ³•åœ‹"]}, {t:"ç¤¾æœƒ",q:"å°ç£æœ€é«˜çš„å±±ï¼Ÿ",a:"ç‰å±±",o:["ç‰å±±","é˜¿é‡Œå±±","é™½æ˜å±±","é›ªå±±"]},
            {t:"ç¤¾æœƒ",q:"å“ªå€‹æ˜¯ç›´è½„å¸‚ï¼Ÿ",a:"é«˜é›„å¸‚",o:["é«˜é›„å¸‚","åŸºéš†å¸‚","æ–°ç«¹å¸‚","å˜‰ç¾©å¸‚"]},
            {t:"è‡ªç„¶",q:"æ¤ç‰©è£½é€ é¤Šåˆ†ï¼Ÿ",a:"å…‰åˆä½œç”¨",o:["å…‰åˆä½œç”¨","å‘¼å¸ä½œç”¨","è’¸æ•£ä½œç”¨","æ¶ˆåŒ–ä½œç”¨"]},
            {t:"è‡ªç„¶",q:"æœˆäº®ç¹è‘—èª°è½‰ï¼Ÿ",a:"åœ°çƒ",o:["åœ°çƒ","å¤ªé™½","ç«æ˜Ÿ","é‡‘æ˜Ÿ"]}, {t:"è‡ªç„¶",q:"æ˜†èŸ²æœ‰å¹¾éš»è…³ï¼Ÿ",a:"6éš»",o:["6éš»","4éš»","8éš»","10éš»"]},
            {t:"è‹±æ–‡",q:"Thank you æ˜¯ï¼Ÿ",a:"è¬è¬",o:["è¬è¬","å°ä¸èµ·","å†è¦‹","ä½ å¥½"]}, {t:"è‹±æ–‡",q:"Library æ˜¯ï¼Ÿ",a:"åœ–æ›¸é¤¨",o:["åœ–æ›¸é¤¨","å­¸æ ¡","å…¬åœ’","é†«é™¢"]},
            {t:"è‹±æ–‡",q:"Beautiful æ˜¯ï¼Ÿ",a:"ç¾éº—çš„",o:["ç¾éº—çš„","é†œé™‹çš„","ç”Ÿæ°£çš„","å¿«æ¨‚çš„"]},
            {t:"æ•¸å­¸",q:"1å¤©æœ‰å¹¾å°æ™‚ï¼Ÿ",a:"24",o:["24","12","60","365"]}, {t:"æ•¸å­¸",q:"ç›´è§’æ˜¯å¹¾åº¦ï¼Ÿ",a:"90åº¦",o:["90åº¦","60åº¦","45åº¦","180åº¦"]},
            {t:"ç¤¾æœƒ",q:"åŸä½æ°‘ç¥­å…¸ï¼Ÿ",a:"è±å¹´ç¥­",o:["è±å¹´ç¥­","æ½‘æ°´ç¯€","è¬è–ç¯€","è–èª•ç¯€"]}, {t:"è‡ªç„¶",q:"æ°´çµå†°æ˜¯ï¼Ÿ",a:"å‡å›º",o:["å‡å›º","è’¸ç™¼","èåŒ–","æ˜‡è¯"]}
        ],
        high: [ // é«˜å¹´ç´š (Lv1-30)
            {t:"æ•¸å­¸",q:"25 x 4 + 10 = ?",a:"110",o:["110","100","90","120"]}, {t:"æ•¸å­¸",q:"0.5 + 0.8 = ?",a:"1.3",o:["1.3","1.2","0.13","13"]},
            {t:"æ•¸å­¸",q:"ä¸‰è§’å½¢å…§è§’å’Œï¼Ÿ",a:"180åº¦",o:["180åº¦","360åº¦","90åº¦","100åº¦"]}, {t:"æ•¸å­¸",q:"åœ“å‘¨ç‡ç´„ç‚ºï¼Ÿ",a:"3.14",o:["3.14","3.41","3.12","3.00"]},
            {t:"æ•¸å­¸",q:"1å…¬å™¸ = ? å…¬æ–¤",a:"1000",o:["1000","100","10","10000"]},
            {t:"åœ‹èª",q:"å“ªå€‹æ˜¯èª‡é£¾æ³•ï¼Ÿ",a:"ç™½é«®ä¸‰åƒä¸ˆ",o:["ç™½é«®ä¸‰åƒä¸ˆ","èŠ±å…’å°æˆ‘ç¬‘","å¤©æ°£å¾ˆç†±","ä»–è·‘å¾ˆå¿«"]},
            {t:"åœ‹èª",q:"ã€Œè†¾ã€ç‚™äººå£çš„è®€éŸ³ï¼Ÿ",a:"ã„ã„¨ã„Ë‹",o:["ã„ã„¨ã„Ë‹","ã„ã„¨ã„ŸË‹","ã„ã„¨ã„ŸË‹","ã„ã„¨ã„ŸË‹"]},
            {t:"ç¤¾æœƒ",q:"é„­æˆåŠŸè¶•èµ°ï¼Ÿ",a:"è·è˜­äºº",o:["è·è˜­äºº","è¥¿ç­ç‰™äºº","æ—¥æœ¬äºº","æ³•åœ‹äºº"]},
            {t:"ç¤¾æœƒ",q:"å°ç£æœ€é•·æ²³æµï¼Ÿ",a:"æ¿æ°´æºª",o:["æ¿æ°´æºª","é«˜å±æºª","æ·¡æ°´æ²³","å¤§ç”²æºª"]}, {t:"ç¤¾æœƒ",q:"ç«‹æ³•é™¢è² è²¬ï¼Ÿ",a:"åˆ¶å®šæ³•å¾‹",o:["åˆ¶å®šæ³•å¾‹","å¯©åˆ¤","è¡Œæ”¿","è€ƒè©¦"]},
            {t:"è‡ªç„¶",q:"æ§“æ¡¿åŸç†æ”¯é»åœ¨ä¸­é–“ï¼Ÿ",a:"è¹ºè¹ºæ¿",o:["è¹ºè¹ºæ¿","é–‹ç“¶å™¨","éºµåŒ…å¤¾","é‡£é­šç«¿"]},
            {t:"è‡ªç„¶",q:"å¤§æ°£å±¤æœ€å¤šæ°£é«”ï¼Ÿ",a:"æ°®æ°£",o:["æ°®æ°£","æ°§æ°£","äºŒæ°§åŒ–ç¢³","æ°«æ°£"]},
            {t:"è‹±æ–‡",q:"Delicious æ˜¯ï¼Ÿ",a:"ç¾å‘³çš„",o:["ç¾å‘³çš„","å±éšªçš„","ç”Ÿæ°£çš„","å¿«æ¨‚çš„"]}, {t:"è‹±æ–‡",q:"Hospital æ˜¯ï¼Ÿ",a:"é†«é™¢",o:["é†«é™¢","å­¸æ ¡","é£¯åº—","éŠ€è¡Œ"]},
            {t:"è‹±æ–‡",q:"Yesterday æ˜¯ï¼Ÿ",a:"æ˜¨å¤©",o:["æ˜¨å¤©","ä»Šå¤©","æ˜å¤©","å¾Œå¤©"]}, {t:"è‹±æ–‡",q:"Elephant æ˜¯ï¼Ÿ",a:"å¤§è±¡",o:["å¤§è±¡","ç…å­","è€è™","çŒ´å­"]}
        ]
    };

    function setGrade(g) {
        state.grade = g;
        // æ³¨æ„ï¼šé€™è£¡ä¸é‡ç½® usedQï¼Œè®“ localStorage æ±ºå®šæ˜¯å¦ç¹¼çºŒ
        document.getElementById('intro-screen').style.display = 'none';
        document.getElementById('hud').style.display = 'flex';
        const map = {'low':'ğŸ‘¶ ä½å¹´ç´š','mid':'ğŸ‘¦ ä¸­å¹´ç´š','high':'ğŸ§‘â€ğŸ“ é«˜å¹´ç´š'};
        const color = {'low':'#4caf50','mid':'#ff9800','high':'#f44336'};
        document.getElementById('grade-display').innerText = map[g];
        document.getElementById('grade-display').style.background = color[g];
        
        loadProgress(g); // è®€å–é€²åº¦
        renderMap(); 
        updateHUD();
        
        // ç•«é¢æ²å‹•åˆ°ç•¶å‰é—œå¡
        setTimeout(() => { 
            const c = document.querySelector('.level-node.unlocked'); 
            if(c) c.scrollIntoView({block:"center", behavior:"smooth"});
            else document.getElementById('map-viewport').scrollTop = 9999; // å¦‚æœéƒ½æ²’è§£é–(ä¸å¤ªå¯èƒ½)ï¼Œæ²åˆ°åº•
        }, 500);
    }

    function renderMap() {
        const con = document.getElementById('nodes-container'); con.innerHTML = '';
        const startY = 3500 + 250; 
        let d = `M 50% ${startY + 30}`; 
        for(let i=1; i<=TOTAL_LEVELS; i++) {
            let y = startY - (i*110); 
            let x = 50 + Math.sin(i * 0.8) * 35; 
            d += ` L ${x}% ${y}`;
            const n = document.createElement('div');
            
            if (i === TOTAL_LEVELS) {
                n.className = `level-node final-node ${i<=state.level?'unlocked':''}`;
                n.innerHTML = '<span>ğŸ°</span>çµ‚é»';
            } else {
                n.className = `level-node ${i<state.level?'cleared':(i==state.level?'unlocked':'')}`;
                n.innerText = i;
            }

            n.style.left = `calc(${x}% - ${i===TOTAL_LEVELS?'55px':'32.5px'})`; 
            n.style.top = `calc(${y}px - ${i===TOTAL_LEVELS?'55px':'32.5px'})`;
            
            if(i <= state.level) n.onclick = () => startLevel(i);
            con.appendChild(n);
        }
        const pathData = d.replace(/50%/g, window.innerWidth/2);
        document.getElementById('map-path-border').setAttribute('d', pathData);
        document.getElementById('map-path-surface').setAttribute('d', pathData);
    }

    function startLevel(lv) {
        if(lv > state.level) return;
        state.inGame = true; state.shieldOn = false;
        document.getElementById('game-modal').classList.add('active');
        document.getElementById('lv-title').innerText = `Level ${lv}`;
        genQuestion(lv);
        let t = 30; document.getElementById('q-timer').innerText = t+"s";
        if(state.timer) clearInterval(state.timer);
        state.timer = setInterval(() => {
            t--; state.totalTime++;
            document.getElementById('q-timer').innerText = t+"s";
            document.getElementById('t-bar').style.width = (t/30*100)+"%";
            document.getElementById('total-time').innerText = state.totalTime;
            if(t<=0) gameOver();
        }, 1000);
        updateGameItemCount();
    }

    function genQuestion(lv) {
        const pool = DB[state.grade];
        let qData;

        let availableIdx = pool.map((_, i) => i).filter(i => !state.usedQ.includes(i));
        
        // æ•¸å­¸é¡Œç”¢ç”Ÿé‚è¼¯ï¼šè‹¥é¡Œåº«ç”¨å®Œ æˆ– æ¯3é—œå‡ºç¾ä¸€æ¬¡
        if (availableIdx.length === 0 || lv % 3 === 0) {
            qData = genMath(lv, state.grade);
        } else {
            const randomIdx = availableIdx[Math.floor(Math.random() * availableIdx.length)];
            state.usedQ.push(randomIdx); 
            qData = pool[randomIdx];
        }

        document.getElementById('subj-tag').innerText = qData.t;
        document.getElementById('q-content').innerText = qData.q;
        const optsDiv = document.getElementById('q-opts'); optsDiv.innerHTML = '';
        
        let opts = qData.o.map(String); 
        opts.sort(()=>0.5-Math.random()).forEach(o => {
            const b = document.createElement('button'); b.className='opt-btn'; b.innerText=o;
            b.onclick = () => checkAns(o, qData.a); optsDiv.appendChild(b);
        });
    }

    // ğŸ§® æ•¸å­¸å‹•æ…‹ç”Ÿæˆå™¨
    function genMath(lv, grade) {
        const r = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
        let n1, n2, ans, q, o;
        
        if (grade === 'low') {
            if(lv < 15) { n1=r(1,10); n2=r(1,9); q=`${n1} + ${n2} = ?`; ans=n1+n2; } else { n1=r(10,30); n2=r(5,15); q=`${n1} - ${n2} = ?`; ans=n1-n2; }
            o = [ans, ans+1, ans-1, ans+2];
        } else if (grade === 'mid') {
            if(lv < 15) { n1=r(2,9); n2=r(2,9); q=`${n1} Ã— ${n2} = ?`; ans=n1*n2; o = [ans, ans+n2, ans-n2, ans+10]; } else { n1=r(100,500); n2=r(10,50); q=`${n1} + ${n2} = ?`; ans=n1+n2; o = [ans, ans+10, ans-10, ans+100]; }
        } else { 
            if(lv < 15) { n1=r(11,20); n2=r(2,5); let n3=r(1,10); q=`${n1} Ã— ${n2} - ${n3} = ?`; ans=n1*n2-n3; o = [ans, ans+1, ans-1, ans+5]; } else { n1=r(10,99); n2=r(2,9); q=`${n1} Ã— ${n2} = ?`; ans=n1*n2; o = [ans, ans+10, ans-10, ans+n2]; }
        }
        return { t:"æ•¸å­¸", q:q, a:ans, o:o };
    }

    function checkAns(ans, correct) {
        if(!state.inGame) return;
        if(String(ans) === String(correct)) { winLevel(); }
        else {
            if(state.shieldOn) { alert("ğŸ›¡ï¸ è­·ç›¾ç”Ÿæ•ˆï¼"); state.shieldOn=false; }
            else { alert("âŒ ç­”éŒ¯ +5ç§’ï¼"); state.totalTime+=5; }
            updateHUD();
        }
    }

    function winLevel() {
        clearInterval(state.timer); state.inGame = false;
        document.getElementById('game-modal').classList.remove('active');
        if(state.level % 5 === 0) {
            let gift = ['time','shield','key'][Math.floor(Math.random()*3)];
            state.items[gift]++; alert(`ğŸ é€šé BOSS é—œå¡ï¼ç²å¾—é“å…·ï¼š${gift}`);
        }
        if(state.level < TOTAL_LEVELS) { 
            state.level++; saveProgress(state.grade); renderMap(); 
            setTimeout(() => { const n = document.querySelector('.level-node.unlocked'); if(n) n.scrollIntoView({block:"center",behavior:"smooth"}); }, 300); 
        }
        else { gameWin(); }
        updateHUD();
    }

    function gameOver() { clearInterval(state.timer); state.inGame=false; alert("ğŸ’€ æ™‚é–“åˆ°ï¼"); document.getElementById('game-modal').classList.remove('active'); }
    function gameWin() { document.getElementById('win-modal').classList.add('active'); document.getElementById('final-time').innerText = state.totalTime; document.getElementById('final-grade').innerText = document.getElementById('grade-display').innerText; }

    function useItem(type) {
        if(!state.inGame && type !== 'key') return; 
        if(state.items[type]>0) {
            state.items[type]--;
            if(type==='time') { state.totalTime = Math.max(0, state.totalTime-10); alert("â³ æ™‚é–“ -10ç§’"); }
            if(type==='shield') { state.shieldOn=true; alert("ğŸ›¡ï¸ è­·ç›¾é–‹å•Ÿ"); }
            if(type==='key') { if(state.inGame) winLevel(); else alert("è«‹åœ¨é—œå¡ä¸­ä½¿ç”¨"); }
            updateHUD(); updateGameItemCount(); saveProgress(state.grade);
        } else { alert("é“å…·ä¸è¶³"); }
    }
    
    function updateHUD() {
        document.getElementById('c-time').innerText = state.items.time; document.getElementById('c-shield').innerText = state.items.shield; document.getElementById('c-key').innerText = state.items.key;
        document.getElementById('total-time').innerText = state.totalTime;
    }
    function updateGameItemCount() {
        document.getElementById('g-c-time').innerText = state.items.time; document.getElementById('g-c-shield').innerText = state.items.shield; document.getElementById('g-c-key').innerText = state.items.key;
    }

    function saveProgress(g) { localStorage.setItem('adv_save_v34_' + g, JSON.stringify({ level: state.level, items: state.items, time: state.totalTime, usedQ: state.usedQ })); }
    function loadProgress(g) {
        const s = localStorage.getItem('adv_save_v34_' + g);
        if(s) { const d = JSON.parse(s); state.level = d.level; state.items = d.items; state.totalTime = d.time; state.usedQ = d.usedQ || []; } else { state.level = 1; state.items = {time:2,shield:2,key:1}; state.totalTime = 0; state.usedQ = []; }
    }

    // ğŸ”¥ V6.0 ä¿®å¾©ï¼šåŠ å…¥ game: 'adventure' (å­˜åˆ° Rank è¡¨)
    function submitScore() {
        const n = document.getElementById('input-name').value.trim();
        if(!n) { alert("è«‹è¼¸å…¥åå­—"); return; }
        
        const btn = document.querySelector('#win-modal button');
        btn.disabled = true; btn.innerText = "ä¸Šå‚³ä¸­...";

        fetch(API_URL, { 
            method:'POST', 
            body:JSON.stringify({game:'adventure', name:n, grade:state.grade, time:state.totalTime}), 
            headers:{"Content-Type":"text/plain"} 
        })
        .then(r=>r.json()).then(d=>{ alert("âœ… ä¸Šå‚³æˆåŠŸ"); location.reload(); })
        .catch(e=>{ alert("ä¸Šå‚³å¤±æ•—"); btn.disabled = false; });
    }

    function openRank() { document.getElementById('rank-modal').classList.add('active'); loadRank(state.grade); }
    
    // ğŸ”¥ V6.0 ä¿®å¾©ï¼šåŠ å…¥ game=adventure & sort=asc (ç§’æ•¸è¶ŠçŸ­è¶Šå¥½)
    function loadRank(grade, btn) {
        if(btn) { document.querySelectorAll('.rt-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        const div = document.getElementById('rank-list'); div.innerHTML = '<div style="text-align:center;">è¼‰å…¥ä¸­...</div>';
        
        fetch(API_URL + `?action=getRank&game=adventure&sort=asc&grade=${grade}`)
            .then(r=>r.json())
            .then(d=>{
                div.innerHTML = ""; if(d.length==0) div.innerHTML = '<div style="text-align:center;">å°šç„¡ç´€éŒ„</div>';
                d.forEach((row,i) => {
                    let medal = i===0?'ğŸ¥‡':(i===1?'ğŸ¥ˆ':(i===2?'ğŸ¥‰':(i+1+'.')));
                    // é€™è£¡è®€å– row.time (V6.0 GAS å›å‚³)
                    div.innerHTML += `<div class="rank-row"><span>${medal} ${row.name}</span><span>${row.time}s</span></div>`;
                });
            })
            .catch(e=>{ div.innerHTML = "è¼‰å…¥å¤±æ•—"; });
    }
</script>
</body>
</html>