<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‚‘ç‰¹ä½©å¤§å†’éšªï¼šæ™‚ç©ºç©¿è¶Šè€… (V32æœ¬åœ°ç‰ˆ)</title>
    <style>
        :root { --locked: #555; --unlocked: #29b6f6; --cleared: #ffb300; }
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; margin: 0; padding: 0; background: #111; color: white; user-select: none; overflow: hidden; }

        /* === ğŸ—ºï¸ åœ°åœ–è¦–çª— === */
        #map-viewport {
            width: 100%; height: 100vh; overflow-y: auto; overflow-x: hidden;
            /* ä¿®æ­£ï¼šå¢åŠ é ‚éƒ¨å’Œåº•éƒ¨å…§è·ï¼Œé˜²æ­¢é—œå¡è¢« HUD æˆ–å°èˆªæ¬„æ“‹ä½ */
            padding-top: 80px; 
            padding-bottom: 100px;
            position: relative; scroll-behavior: smooth; background: #000;
        }

        /* === ğŸŒ äº”å¤§ä¸–ç•Œ (è®€å–æœ¬åœ°æ ¹ç›®éŒ„åœ–ç‰‡) === */
        /* è«‹ç¢ºä¿ bg_forest.jpg ç­‰ 5 å¼µåœ–ç‰‡èˆ‡æ­¤ HTML åœ¨åŒä¸€è³‡æ–™å¤¾å…§ */
        .zone {
            position: absolute; width: 100%; height: 750px; left: 0; z-index: 0;
            background-size: cover; background-position: center;
            background-color: #333; /* åœ–ç‰‡æœªè¼‰å…¥æ™‚çš„åº•è‰² */
            border-top: 5px solid rgba(0,0,0,0.5);
            /* é»‘è‰²é®ç½©ï¼šåŠ æ·±èƒŒæ™¯ï¼Œå‡¸é¡¯å‰æ™¯é“è·¯èˆ‡é—œå¡ */
            box-shadow: inset 0 0 0 1000px rgba(0,0,0,0.4);
        }
        
        /* World 1: è¿·éœ§æ£®æ— */
        .zone-1 { 
            top: 2800px; 
            background-image: url('bg_forest.jpg'); /* è®€å–æœ¬åœ°åœ–ç‰‡ */
            box-shadow: inset 0 0 0 1000px rgba(0, 40, 0, 0.5); 
        }
        /* World 2: çƒˆæ—¥æ²™æ¼  */
        .zone-2 { 
            top: 2100px; 
            background-image: url('bg_desert.jpg'); /* è®€å–æœ¬åœ°åœ–ç‰‡ */
            box-shadow: inset 0 0 0 1000px rgba(180, 80, 0, 0.3); 
        }
        /* World 3: æ¥µåœ°å†°åŸ */
        .zone-3 { 
            top: 1400px; 
            background-image: url('bg_ice.jpg'); /* è®€å–æœ¬åœ°åœ–ç‰‡ */
            box-shadow: inset 0 0 0 1000px rgba(0, 80, 150, 0.4); 
        }
        /* World 4: ç†”å²©ç«å±± */
        .zone-4 { 
            top: 700px; 
            background-image: url('bg_volcano.jpg'); /* è®€å–æœ¬åœ°åœ–ç‰‡ */
            box-shadow: inset 0 0 0 1000px rgba(100, 0, 0, 0.5); 
        }
        /* World 5: æ©Ÿæ¢°åŸå ¡ */
        .zone-5 { 
            top: 0px;
            height: 800px; /* åŠ é«˜æœ€å¾Œä¸€å€ï¼Œç¢ºä¿é ‚éƒ¨ç©ºé–“ */
            background-image: url('bg_mech.jpg'); /* è®€å–æœ¬åœ°åœ–ç‰‡ */
            box-shadow: inset 0 0 0 1000px rgba(0, 0, 0, 0.7); 
        }

        .zone-label {
            position: absolute; top: 50px; left: 30px; font-size: 2.5rem; font-weight: bold;
            color: rgba(255,255,255,0.95); text-transform: uppercase; letter-spacing: 3px;
            text-shadow: 3px 3px 0 #000; pointer-events: none;
        }
        .zone-5 .zone-label { top: 150px; } /* ä¿®æ­£ï¼šç¢ºä¿ World 5 æ¨™é¡Œä¸è¢« HUD æ“‹ä½ */

        /* === ğŸ›£ï¸ çœŸå¯¦é“è·¯ç³»çµ± (å¯¬é—Šå¤§é“) === */
        #path-svg { 
            position: absolute; top: 0; left: 0; width: 100%; height: 3600px; 
            pointer-events: none; z-index: 5; 
        }
        path { fill: none; stroke-linecap: round; stroke-linejoin: round; }
        /* ç¬¬1å±¤ï¼šè·¯åŸº */
        #map-path-border { stroke: #3e2723; stroke-width: 60px; filter: blur(2px); opacity: 0.8; }
        /* ç¬¬2å±¤ï¼šè·¯é¢ */
        #map-path-surface { stroke: #d7ccc8; stroke-width: 45px; stroke-dasharray: 20 10; }

        /* === é—œå¡ç¯€é» === */
        .level-node {
            position: absolute; width: 60px; height: 60px; border-radius: 50%;
            background: var(--locked); border: 5px solid #fff; left: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.4rem; cursor: pointer; z-index: 10;
            box-shadow: 0 5px 25px rgba(0,0,0,0.8); transition: 0.2s; color: #aaa;
        }
        .level-node.unlocked { 
            background: var(--unlocked); color: white; 
            animation: pulse 1.5s infinite; border-color: white; 
            box-shadow: 0 0 30px var(--unlocked); transform: scale(1.1);
        }
        .level-node.cleared { background: var(--cleared); color: #3e2723; border-color: #fff8e1; }
        .level-node:active { transform: scale(0.95); }

        /* === UI ä»‹é¢ === */
        .intro-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .grade-btn { width: 80%; max-width: 300px; padding: 20px; margin: 10px; border: none; border-radius: 15px; font-size: 1.5rem; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 6px 0 rgba(0,0,0,0.5); }
        .grade-btn:active { transform: translateY(6px); box-shadow: none; }
        .g-low { background: #4caf50; } .g-mid { background: #ff9800; } .g-high { background: #f44336; }
        
        #hud { position: fixed; top: 0; left: 0; width: 100%; padding: 10px; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 100; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; border-bottom: 2px solid #444; }
        .status-box { font-size: 0.9rem; display: flex; gap: 15px; color: #fff; align-items: center; }
        .item-icon { position: relative; font-size: 1.6rem; cursor: pointer; transition: 0.2s; } 
        .item-count { position: absolute; bottom: -2px; right: -5px; background: #e74c3c; font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; border:1px solid white; font-weight: bold; }
        .grade-badge { padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 200; flex-direction: column; backdrop-filter: blur(8px); }
        .modal.active { display: flex; animation: fadeIn 0.3s; } @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        
        .game-board { background: #f5f5f5; color: #333; width: 90%; max-width: 450px; border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.8); position: relative; border: 5px solid #fff; }
        .game-content { min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.8rem; font-weight: bold; margin: 20px 0; color:#2c3e50; }
        .subj-tag { font-size: 1rem; background: #2c3e50; color: white; padding: 5px 12px; border-radius: 5px; margin-bottom: 10px; position: absolute; top: 20px; left: 20px; }
        
        .grid-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .opt-btn { padding: 18px; background: #3498db; color: white; border: none; border-radius: 12px; font-size: 1.3rem; cursor: pointer; font-weight:bold; box-shadow: 0 6px 0 #2980b9; transition:0.1s; } 
        .opt-btn:active{transform:translateY(6px); box-shadow:none;}

        .rank-tabs { display: flex; gap: 10px; margin-bottom: 15px; background:#ddd; padding:5px; border-radius:10px; }
        .rt-btn { flex: 1; padding: 10px; background: transparent; border: none; cursor: pointer; font-weight: bold; border-radius:8px; color:#777; transition:0.2s; }
        .rt-btn.active { background: #fff; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .rank-row { display: flex; justify-content: space-between; padding: 12px 10px; border-bottom: 1px solid #ddd; font-size: 1rem; }
        .rank-row:nth-child(1) { color: #d35400; font-weight: bold; font-size: 1.1rem; border: 2px solid #f39c12; background: #fff8e1; border-radius: 8px; margin-bottom: 5px;}

        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(41, 182, 246, 0.7); } 70% { transform: scale(1.15); box-shadow: 0 0 0 25px rgba(41, 182, 246, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(41, 182, 246, 0); } }
    </style>
</head>
<body>

<div class="intro-modal" id="intro-screen">
    <h1 style="color:#fff; margin-bottom:10px; text-shadow:0 4px 10px rgba(0,0,0,0.8);">ğŸš€ å‚‘ç‰¹ä½©å¤§å†’éšª</h1>
    <p style="color:#aaa; margin-bottom:30px;">å…¨ç§‘æŒ‘æˆ°ï¼æ™‚ç©ºç©¿è¶Š</p>
    <button class="grade-btn g-low" onclick="setGrade('low')">ğŸ‘¶ ä½å¹´ç´š (1-2)</button>
    <button class="grade-btn g-mid" onclick="setGrade('mid')">ğŸ‘¦ ä¸­å¹´ç´š (3-4)</button>
    <button class="grade-btn g-high" onclick="setGrade('high')">ğŸ§‘â€ğŸ“ é«˜å¹´ç´š (5-6)</button>
</div>

<div id="hud" style="display:none;">
    <div class="status-box">
        <span id="grade-display" class="grade-badge"></span>
        <span>â±ï¸ <span id="total-time">0</span>s</span>
    </div>
    <div class="status-box">
        <div class="item-icon" onclick="useItem('time')" title="æ™‚é–“-10s">â³<span class="item-count" id="c-time">0</span></div>
        <div class="item-icon" onclick="useItem('shield')" title="æŠµæ“‹ä¸€æ¬¡éŒ¯èª¤">ğŸ›¡ï¸<span class="item-count" id="c-shield">0</span></div>
        <div class="item-icon" onclick="useItem('key')" title="è·³éæ­¤é—œ">ğŸ”‘<span class="item-count" id="c-key">0</span></div>
    </div>
</div>

<div id="map-viewport">
    <div class="zone zone-5"><div class="zone-label">World 5: æ©Ÿæ¢°åŸå ¡</div></div>
    <div class="zone zone-4"><div class="zone-label">World 4: ç†”å²©ç«å±±</div></div>
    <div class="zone zone-3"><div class="zone-label">World 3: æ¥µåœ°å†°åŸ</div></div>
    <div class="zone zone-2"><div class="zone-label">World 2: çƒˆæ—¥æ²™æ¼ </div></div>
    <div class="zone zone-1"><div class="zone-label">World 1: è¿·éœ§æ£®æ—</div></div>
    <svg id="path-svg">
        <path id="map-path-border" d=""/>
        <path id="map-path-surface" d=""/>
    </svg>
    <div id="nodes-container"></div>
</div>

<div class="modal" id="game-modal">
    <div class="game-board">
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem; margin-bottom:5px; padding-left: 50px;">
            <span id="lv-title">Level 1</span>
            <span id="q-timer" style="color:#e74c3c;">30s</span>
        </div>
        <div style="height:10px; background:#ddd; border-radius:5px; overflow:hidden; margin-bottom:15px;"><div id="t-bar" style="height:100%; width:100%; background:#e74c3c; transition:width 1s linear;"></div></div>
        
        <div class="game-content">
            <div id="subj-tag" class="subj-tag">ç§‘ç›®</div>
            <div id="q-content">é¡Œç›®è¼‰å…¥ä¸­...</div>
        </div>
        
        <div class="grid-options" id="q-opts"></div>
        <div style="margin-top:25px; display:flex; justify-content:center; gap:20px; border-top:2px solid #eee; padding-top:20px;">
            <div class="item-icon" onclick="useItem('time')" style="color:#333;">â³<span class="item-count" id="g-c-time">0</span></div>
            <div class="item-icon" onclick="useItem('shield')" style="color:#333;">ğŸ›¡ï¸<span class="item-count" id="g-c-shield">0</span></div>
            <div class="item-icon" onclick="useItem('key')" style="color:#333;">ğŸ”‘<span class="item-count" id="g-c-key">0</span></div>
        </div>
    </div>
</div>

<div class="modal" id="win-modal">
    <div class="game-board">
        <h1 style="color:#27ae60; margin-top:0;">ğŸ† æŒ‘æˆ°æˆåŠŸï¼</h1>
        <p>ç­‰ç´šï¼š<span id="final-grade" style="font-weight:bold;"></span></p>
        <p>ç¸½è€—æ™‚ï¼š<span id="final-time" style="font-size:3rem; color:#e74c3c; font-weight:bold;"></span> ç§’</p>
        <input type="text" id="input-name" placeholder="è¼¸å…¥åå­— (ä¾‹: 401å°æ˜)" style="padding:15px; font-size:1.2rem; width:90%; border:2px solid #ddd; border-radius:10px; text-align:center;">
        <br><br>
        <button class="opt-btn" style="width:100%; background:#27ae60; box-shadow:0 6px 0 #219a52;" onclick="submitScore()">ä¸Šå‚³è‹±é›„æ¦œ</button>
        <button class="opt-btn" style="width:100%; background:#7f8c8d; margin-top:15px; box-shadow:0 6px 0 #636e72;" onclick="location.reload()">å›é¦–é é‡ç½®</button>
    </div>
</div>

<div class="modal" id="rank-modal">
    <div class="game-board" style="max-height:80vh; overflow-y:auto; padding:0; background:#f9f9f9;">
        <div style="padding:20px; background:#2c3e50; color:white; border-radius:20px 20px 0 0;">
            <h2 style="margin:0;">ğŸ† å†’éšªè‹±é›„æ¦œ</h2>
        </div>
        <div style="padding:20px;">
            <div class="rank-tabs">
                <button class="rt-btn active" onclick="loadRank('low', this)">ğŸ‘¶ ä½å¹´ç´š</button>
                <button class="rt-btn" onclick="loadRank('mid', this)">ğŸ‘¦ ä¸­å¹´ç´š</button>
                <button class="rt-btn" onclick="loadRank('high', this)">ğŸ§‘â€ğŸ“ é«˜å¹´ç´š</button>
            </div>
            <div id="rank-list" style="text-align:left; min-height:200px;">è¼‰å…¥ä¸­...</div>
            <button class="opt-btn" style="background:#7f8c8d; margin-top:20px; font-size:1rem; padding:12px; width:100%; box-shadow:0 4px 0 #636e72;" onclick="document.getElementById('rank-modal').classList.remove('active')">é—œé–‰</button>
        </div>
    </div>
</div>

<style> body { padding-bottom: 80px !important; } #jetpay-navbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; height: 65px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 50px; border: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999; } .nav-item { text-decoration: none; color: #95a5a6; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; transition: 0.2s; } .nav-icon { font-size: 1.6rem; margin-bottom: 2px; } .nav-item:hover { color: #2c3e50; transform: translateY(-2px); } .nav-item-special { color: #e67e22; font-weight: bold; } .nav-item-special .nav-icon { background: #e67e22; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(230, 126, 34, 0.4); margin-top: -20px; border: 4px solid white; } </style>
<div id="jetpay-navbar">
    <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>é¦–é </span></a>
    <a href="simple_games.html" class="nav-item"><span class="nav-icon">ğŸ§©</span><span>ç°¡å–®</span></a>
    <a href="adventure_map.html" class="nav-item nav-item-special"><span class="nav-icon">ğŸ°</span><span>é—–é—œ</span></a>
    <a href="knowledge_games.html" class="nav-item"><span class="nav-icon">ğŸ“š</span><span>çŸ¥è­˜</span></a>
    <a href="#" class="nav-item" onclick="openRank()"><span class="nav-icon">ğŸ†</span><span>æ’è¡Œ</span></a>
</div>

<script>
    // ğŸ”´ ğŸ”´ ğŸ”´ è«‹åœ¨ä¸‹æ–¹è²¼ä¸Šæ‚¨ GAS (Apps Script) çš„ç¶²å€ ğŸ”´ ğŸ”´ ğŸ”´
    const API_URL = "https://script.google.com/macros/s/AKfycbwKUB2BPH1jD7ch2yenKSokuHq15ktPk1UfORI0RVNYVL6_oIBISNr27MX5Yng-7i-DqA/exec";

    const TOTAL_LEVELS = 30;
    let state = { grade: 'mid', level: 1, items: { time: 2, shield: 2, key: 1 }, totalTime: 0, timer: null, inGame: false, shieldOn: false };

    // å…¨ç§‘é¡Œåº«
    const DB = {
        low: [
            {t:"æ•¸å­¸", q:"5 + 8 = ?", a:"13", o:["13","12","14","15"]},
            {t:"æ•¸å­¸", q:"20 - 7 = ?", a:"13", o:["13","12","11","10"]},
            {t:"æ•¸å­¸", q:"3å€‹5æ˜¯å¤šå°‘?", a:"15", o:["15","10","20","12"]},
            {t:"ç”Ÿæ´»", q:"ç´…ç‡ˆä»£è¡¨ä»€éº¼?", a:"åœæ­¢", o:["åœæ­¢","å‰é€²","è·³èˆ","å”±æ­Œ"]},
            {t:"ç”Ÿæ´»", q:"éé¦¬è·¯è¦èµ°?", a:"æ–‘é¦¬ç·š", o:["æ–‘é¦¬ç·š","å¿«è»Šé“","å±‹é ‚","æ°´æº"]},
            {t:"åœ‹èª", q:"ã€Œæ—©ã€çš„éƒ¨é¦–?", a:"æ—¥", o:["æ—¥","å","å£","è‰"]},
            {t:"åœ‹èª", q:"ã€ŒèŠ±ã€çš„éƒ¨é¦–?", a:"è‰¸", o:["è‰¸","åŒ–","äºº","æœ¨"]},
            {t:"è‹±æ–‡", q:"Red æ˜¯ä»€éº¼è‰²?", a:"ç´…è‰²", o:["ç´…è‰²","è—è‰²","ç¶ è‰²","é»ƒè‰²"]},
            {t:"è‹±æ–‡", q:"Cat æ˜¯ä»€éº¼?", a:"è²“", o:["è²“","ç‹—","è±¬","é³¥"]},
            {t:"è‡ªç„¶", q:"å¤ªé™½å¾å“ªé‚Šå‡ºä¾†?", a:"æ±é‚Š", o:["æ±é‚Š","è¥¿é‚Š","åŒ—é‚Š","å—é‚Š"]}
        ],
        mid: [
            {t:"æ•¸å­¸", q:"8 x 7 = ?", a:"56", o:["56","48","64","54"]},
            {t:"æ•¸å­¸", q:"45 Ã· 5 = ?", a:"9", o:["9","8","7","6"]},
            {t:"æ•¸å­¸", q:"1å…¬é‡Œ = ? å…¬å°º", a:"1000", o:["1000","100","10","10000"]},
            {t:"ç¤¾æœƒ", q:"æˆ‘å€‘ä½åœ¨å“ªè£¡?", a:"å°ç£", o:["å°ç£","ç¾åœ‹","æ—¥æœ¬","æ³•åœ‹"]},
            {t:"ç¤¾æœƒ", q:"ç«¯åˆç¯€åƒä»€éº¼?", a:"ç²½å­", o:["ç²½å­","æœˆé¤…","æ¹¯åœ“","è›‹ç³•"]},
            {t:"åœ‹èª", q:"æˆèª:ä¸€__é©šäºº", a:"é³´", o:["é³´","å","æ°‘","æ˜"]},
            {t:"åœ‹èª", q:"å®ˆæ ªå¾…__?", a:"å…”", o:["å…”","è™","è±¬","é¾"]},
            {t:"è‡ªç„¶", q:"ç£éµèƒ½å¸ä»€éº¼?", a:"éµé‡˜", o:["éµé‡˜","å¡‘è† ","æœ¨é ­","ç´™"]},
            {t:"è‡ªç„¶", q:"é’è›™å°æ™‚å€™æ˜¯?", a:"èŒèšª", o:["èŒèšª","æ¯›æ¯›èŸ²","å°é­š","é›è›‹"]},
            {t:"è‹±æ–‡", q:"Thank you æ˜¯?", a:"è¬è¬", o:["è¬è¬","å°ä¸èµ·","å†è¦‹","ä½ å¥½"]}
        ],
        high: [
            {t:"æ•¸å­¸", q:"25 x 4 + 10 = ?", a:"110", o:["110","100","90","120"]},
            {t:"æ•¸å­¸", q:"0.5 + 0.8 = ?", a:"1.3", o:["1.3","1.2","0.13","13"]},
            {t:"æ•¸å­¸", q:"ä¸‰è§’å½¢å…§è§’å’Œ?", a:"180åº¦", o:["180åº¦","360åº¦","90åº¦","100åº¦"]},
            {t:"ç¤¾æœƒ", q:"å°ç£æœ€é«˜çš„å±±?", a:"ç‰å±±", o:["ç‰å±±","é˜¿é‡Œå±±","é›ªå±±","é™½æ˜å±±"]},
            {t:"ç¤¾æœƒ", q:"å“ªå€‹æ˜¯ç›´è½„å¸‚?", a:"é«˜é›„å¸‚", o:["é«˜é›„å¸‚","åŸºéš†å¸‚","æ–°ç«¹å¸‚","å˜‰ç¾©å¸‚"]},
            {t:"è‡ªç„¶", q:"æ¤ç‰©è£½é€ é¤Šåˆ†?", a:"å…‰åˆä½œç”¨", o:["å…‰åˆä½œç”¨","å‘¼å¸ä½œç”¨","è’¸æ•£ä½œç”¨","æ¶ˆåŒ–ä½œç”¨"]},
            {t:"è‡ªç„¶", q:"æœˆäº®ç¹è‘—èª°è½‰?", a:"åœ°çƒ", o:["åœ°çƒ","å¤ªé™½","ç«æ˜Ÿ","é‡‘æ˜Ÿ"]},
            {t:"åœ‹èª", q:"å“ªå€‹å­—æœ‰éŒ¯?", a:"å†æ¥å†å‹µ", o:["å†æ¥å†å‹µ","å†æ¥å†å²","é¥è€Œä¸æ¨","å …æŒåˆ°åº•"]}, // å²æ‰å°
            {t:"è‹±æ–‡", q:"Library æ˜¯?", a:"åœ–æ›¸é¤¨", o:["åœ–æ›¸é¤¨","å­¸æ ¡","å…¬åœ’","é†«é™¢"]},
            {t:"è‹±æ–‡", q:"Delicious æ˜¯?", a:"ç¾å‘³çš„", o:["ç¾å‘³çš„","å±éšªçš„","ç”Ÿæ°£çš„","å¿«æ¨‚çš„"]}
        ]
    };

    function setGrade(g) {
        state.grade = g;
        document.getElementById('intro-screen').style.display = 'none';
        document.getElementById('hud').style.display = 'flex';
        const map = {'low':'ğŸ‘¶ ä½å¹´ç´š','mid':'ğŸ‘¦ ä¸­å¹´ç´š','high':'ğŸ§‘â€ğŸ“ é«˜å¹´ç´š'};
        const color = {'low':'#4caf50','mid':'#ff9800','high':'#f44336'};
        document.getElementById('grade-display').innerText = map[g];
        document.getElementById('grade-display').style.background = color[g];
        loadProgress(g); renderMap(); updateHUD();
        setTimeout(() => { const c = document.querySelector('.level-node.unlocked'); if(c) c.scrollIntoView({block:"center",behavior:"smooth"}); }, 500);
    }

    function renderMap() {
        const con = document.getElementById('nodes-container'); con.innerHTML = '';
        // ä¿®æ­£ï¼šå°‡åœ°åœ–æ•´é«”å¾€ä¸‹ç§»ï¼Œç¢ºä¿ç¬¬ 30 é—œä¸è¢«æ“‹ä½
        const startY = 3500 + 200; // å¢åŠ é ‚éƒ¨ç©ºé–“
        let d = `M 50% ${startY + 30}`; 
        for(let i=1; i<=TOTAL_LEVELS; i++) {
            let y = startY - (i*110); 
            let x = 50 + Math.sin(i * 0.8) * 35; 
            d += ` L ${x}% ${y}`;
            const n = document.createElement('div');
            n.className = `level-node ${i<state.level?'cleared':(i==state.level?'unlocked':'')}`;
            n.style.left = `calc(${x}% - 30px)`; n.style.top = `calc(${y}px - 30px)`; n.innerText = i;
            if(i <= state.level) n.onclick = () => startLevel(i);
            con.appendChild(n);
        }
        
        // ğŸ›£ï¸ ç¹ªè£½å…©å±¤é“è·¯
        const pathData = d.replace(/50%/g, window.innerWidth/2);
        document.getElementById('map-path-border').setAttribute('d', pathData);
        document.getElementById('map-path-surface').setAttribute('d', pathData);
    }

    function startLevel(lv) {
        if(lv > state.level) return;
        state.inGame = true; state.shieldOn = false;
        document.getElementById('game-modal').classList.add('active');
        document.getElementById('lv-title').innerText = `Level ${lv}`;
        genQuestion(lv);
        let t = 30; document.getElementById('q-timer').innerText = t+"s";
        if(state.timer) clearInterval(state.timer);
        state.timer = setInterval(() => {
            t--; state.totalTime++;
            document.getElementById('q-timer').innerText = t+"s";
            document.getElementById('t-bar').style.width = (t/30*100)+"%";
            document.getElementById('total-time').innerText = state.totalTime;
            if(t<=0) gameOver();
        }, 1000);
        updateGameItemCount();
    }

    function genQuestion(lv) {
        const r = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
        let pool = DB[state.grade] || DB['mid'];
        let qData;
        if(lv % 3 === 0) {
             if(state.grade === 'low') { let n1=r(1,10), n2=r(1,9); qData={t:"æ•¸å­¸", q:`${n1} + ${n2} = ?`, a:n1+n2, o:[n1+n2, n1+n2+1, n1+n2-1, n1+n2+2]}; }
             else if(state.grade === 'mid') { let n1=r(2,9), n2=r(2,9); qData={t:"æ•¸å­¸", q:`${n1} Ã— ${n2} = ?`, a:n1*n2, o:[n1*n2, n1*n2+10, n1*n2-5, n1*n2+1]}; }
             else { let n1=r(11,20), n2=r(2,9); qData={t:"æ•¸å­¸", q:`${n1} Ã— ${n2} = ?`, a:n1*n2, o:[n1*n2, n1*n2+10, n1*n2-10, n1*n2+2]}; }
        } else {
            qData = pool[Math.floor(Math.random() * pool.length)];
        }
        document.getElementById('subj-tag').innerText = qData.t;
        document.getElementById('q-content').innerText = qData.q;
        const optsDiv = document.getElementById('q-opts'); optsDiv.innerHTML = '';
        let opts = qData.o.map(String); 
        opts.sort(()=>0.5-Math.random()).forEach(o => {
            const b = document.createElement('button'); b.className='opt-btn'; b.innerText=o;
            b.onclick = () => checkAns(o, qData.a); optsDiv.appendChild(b);
        });
    }

    function checkAns(ans, correct) {
        if(!state.inGame) return;
        if(String(ans) === String(correct)) { winLevel(); }
        else {
            if(state.shieldOn) { alert("ğŸ›¡ï¸ è­·ç›¾ç”Ÿæ•ˆï¼"); state.shieldOn=false; }
            else { alert("âŒ ç­”éŒ¯ +5ç§’ï¼"); state.totalTime+=5; }
            updateHUD();
        }
    }

    function winLevel() {
        clearInterval(state.timer); state.inGame = false;
        document.getElementById('game-modal').classList.remove('active');
        if(state.level % 5 === 0) {
            let gift = ['time','shield','key'][Math.floor(Math.random()*3)];
            state.items[gift]++; alert(`ğŸ é€šé BOSS é—œå¡ï¼ç²å¾—é“å…·ï¼š${gift}`);
        }
        if(state.level < TOTAL_LEVELS) { state.level++; saveProgress(state.grade); renderMap(); setTimeout(() => { document.querySelector('.level-node.unlocked').scrollIntoView({block:"center",behavior:"smooth"}); }, 300); }
        else { gameWin(); }
        updateHUD();
    }

    function gameOver() { clearInterval(state.timer); state.inGame=false; alert("ğŸ’€ æ™‚é–“åˆ°ï¼"); document.getElementById('game-modal').classList.remove('active'); }
    function gameWin() { document.getElementById('win-modal').classList.add('active'); document.getElementById('final-time').innerText = state.totalTime; document.getElementById('final-grade').innerText = document.getElementById('grade-display').innerText; }

    function useItem(type) {
        if(!state.inGame && type !== 'key') return; 
        if(state.items[type]>0) {
            state.items[type]--;
            if(type==='time') { state.totalTime = Math.max(0, state.totalTime-10); alert("â³ æ™‚é–“ -10ç§’"); }
            if(type==='shield') { state.shieldOn=true; alert("ğŸ›¡ï¸ è­·ç›¾é–‹å•Ÿ"); }
            if(type==='key') { if(state.inGame) winLevel(); else alert("è«‹åœ¨é—œå¡ä¸­ä½¿ç”¨"); }
            updateHUD(); updateGameItemCount(); saveProgress(state.grade);
        } else { alert("é“å…·ä¸è¶³"); }
    }
    
    function updateHUD() {
        document.getElementById('c-time').innerText = state.items.time; document.getElementById('c-shield').innerText = state.items.shield; document.getElementById('c-key').innerText = state.items.key;
        document.getElementById('total-time').innerText = state.totalTime;
    }
    function updateGameItemCount() {
        document.getElementById('g-c-time').innerText = state.items.time; document.getElementById('g-c-shield').innerText = state.items.shield; document.getElementById('g-c-key').innerText = state.items.key;
    }

    function saveProgress(g) { localStorage.setItem('adv_save_v32_' + g, JSON.stringify({ level: state.level, items: state.items, time: state.totalTime })); }
    function loadProgress(g) {
        const s = localStorage.getItem('adv_save_v32_' + g);
        if(s) { const d = JSON.parse(s); state.level = d.level; state.items = d.items; state.totalTime = d.time; }
        else { state.level = 1; state.items = {time:2,shield:2,key:1}; state.totalTime = 0; }
    }

    function submitScore() {
        const n = document.getElementById('input-name').value.trim();
        if(!n) { alert("è«‹è¼¸å…¥åå­—"); return; }
        fetch(API_URL, { method:'POST', body:JSON.stringify({type:'record', name:n, time:state.totalTime, grade:state.grade}), headers:{"Content-Type":"text/plain"} })
        .then(r=>r.json()).then(d=>{ alert("âœ… ä¸Šå‚³æˆåŠŸ"); location.reload(); }).catch(e=>{ alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS ç¶²å€èˆ‡ç¶²è·¯"); });
    }

    function openRank() { document.getElementById('rank-modal').classList.add('active'); loadRank(state.grade); }
    function loadRank(grade, btn) {
        if(btn) { document.querySelectorAll('.rt-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        const div = document.getElementById('rank-list'); div.innerHTML = '<div style="text-align:center;">è¼‰å…¥ä¸­...</div>';
        fetch(API_URL + `?action=getRank&grade=${grade}`).then(r=>r.json()).then(d=>{
            div.innerHTML = ""; if(d.length==0) div.innerHTML = '<div style="text-align:center;">å°šç„¡ç´€éŒ„</div>';
            d.slice(0,10).forEach((row,i) => {
                let medal = i===0?'ğŸ¥‡':(i===1?'ğŸ¥ˆ':(i===2?'ğŸ¥‰':(i+1+'.')));
                div.innerHTML += `<div class="rank-row"><span>${medal} ${row.name}</span><span>${row.time}s</span></div>`;
            });
        }).catch(e=>{ div.innerHTML = "è¼‰å…¥å¤±æ•—"; });
    }
</script>
</body>
</html>