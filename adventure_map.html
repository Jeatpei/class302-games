<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‚‘ç‰¹ä½©å¤§å†’éšªï¼šæ™‚ç©ºç©¿è¶Šè€… V25</title>
    <style>
        :root { --locked: #444; --unlocked: #29b6f6; --cleared: #fbc02d; }
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; margin: 0; padding: 0; background: #222; color: white; user-select: none; overflow: hidden; }

        /* === ğŸ—ºï¸ åœ°åœ–è¦–è¦ºå„ªåŒ– (è§£æ±ºå•é¡Œ1) === */
        #map-viewport {
            width: 100%; height: 100vh; overflow-y: auto; overflow-x: hidden; position: relative; scroll-behavior: smooth;
            padding-bottom: 80px;
        }

        /* äº”å¤§ä¸–ç•ŒèƒŒæ™¯ç´‹ç† */
        .zone { position: absolute; width: 100%; height: 700px; left: 0; z-index: 0; border-top: 5px solid rgba(0,0,0,0.2); }
        
        /* World 1: è¿·éœ§æ£®æ— (ç¶ è‰² + åœ“é»æ¨¹è‘‰) */
        .zone-1 { top: 2800px; background: #2e7d32; background-image: radial-gradient(#4caf50 15%, transparent 16%); background-size: 30px 30px; }
        /* World 2: çƒˆæ—¥æ²™æ¼  (é»ƒè‰² + æ³¢ç´‹) */
        .zone-2 { top: 2100px; background: #f57f17; background-image: repeating-linear-gradient(45deg, #ffb74d 0, #ffb74d 10px, #f57f17 10px, #f57f17 20px); }
        /* World 3: æ¥µåœ°å†°åŸ (è—è‰² + æ™¶é«”) */
        .zone-3 { top: 1400px; background: #0277bd; background-image: linear-gradient(30deg, #4fc3f7 12%, transparent 12.5%, transparent 87%, #4fc3f7 87.5%, #4fc3f7), linear-gradient(150deg, #4fc3f7 12%, transparent 12.5%, transparent 87%, #4fc3f7 87.5%, #4fc3f7); background-size: 40px 70px; }
        /* World 4: ç†”å²©ç«å±± (æ·±ç´… + è£‚ç—•) */
        .zone-4 { top: 700px; background: #b71c1c; background-image: linear-gradient(90deg, transparent 50%, rgba(0,0,0,0.3) 50%); background-size: 50px 50px; }
        /* World 5: æ©Ÿæ¢°åŸå ¡ (ç°è‰² + ç¶²æ ¼) */
        .zone-5 { top: 0px; background: #37474f; background-image: linear-gradient(#546e7a 1px, transparent 1px), linear-gradient(90deg, #546e7a 1px, transparent 1px); background-size: 40px 40px; }

        .zone-label {
            position: absolute; top: 20px; left: 20px; font-size: 2.5rem; font-weight: bold;
            color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 5px;
        }

        /* é—œå¡ç¯€é» */
        .level-node {
            position: absolute; width: 55px; height: 55px; border-radius: 50%;
            background: var(--locked); border: 4px solid #fff; left: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem; cursor: pointer; z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.2s;
        }
        .level-node.unlocked { background: var(--unlocked); animation: pulse 1.5s infinite; border-color: white; }
        .level-node.cleared { background: var(--cleared); color: #333; border-color: #fffde7; }
        
        #path-svg { position: absolute; top: 0; left: 0; width: 100%; height: 3500px; pointer-events: none; z-index: 5; }
        path { fill: none; stroke: rgba(255,255,255,0.6); stroke-width: 8; stroke-dasharray: 15; stroke-linecap: round; }

        /* === åˆå§‹é¸æ“‡åˆ†ç´šè¦–çª— (è§£æ±ºå•é¡Œ3) === */
        .intro-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222;
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .grade-btn {
            width: 80%; max-width: 300px; padding: 20px; margin: 10px; border: none; border-radius: 15px;
            font-size: 1.5rem; font-weight: bold; cursor: pointer; color: white; transition: 0.2s;
        }
        .g-low { background: #4caf50; box-shadow: 0 5px 0 #2e7d32; }
        .g-mid { background: #ff9800; box-shadow: 0 5px 0 #e65100; }
        .g-high { background: #f44336; box-shadow: 0 5px 0 #c62828; }
        .grade-btn:active { transform: translateY(5px); box-shadow: none; }

        /* === HUD & Game UI === */
        #hud {
            position: fixed; top: 0; left: 0; width: 100%; padding: 10px;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 100;
            display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;
        }
        .status-box { font-size: 0.9rem; display: flex; gap: 10px; color: #fff; }
        .item-icon { position: relative; font-size: 1.2rem; margin-right: 5px; cursor: pointer; }
        .item-count { position: absolute; bottom: -5px; right: -5px; background: red; font-size: 0.6rem; padding: 1px 4px; border-radius: 10px; }
        .grade-badge { padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 200; flex-direction: column; }
        .modal.active { display: flex; }
        .game-board { background: white; color: #333; width: 90%; max-width: 450px; border-radius: 15px; padding: 20px; text-align: center; }
        .game-content { min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.8rem; font-weight: bold; margin: 20px 0; }
        .grid-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .opt-btn { padding: 15px; background: #2196f3; color: white; border: none; border-radius: 10px; font-size: 1.2rem; cursor: pointer; }

        /* æ’è¡Œæ¦œåˆ†é  */
        .rank-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .rt-btn { flex: 1; padding: 8px; background: #eee; border: none; cursor: pointer; font-weight: bold; }
        .rt-btn.active { background: #333; color: white; }
        .rank-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .rank-row:first-child { color: #d35400; font-weight: bold; font-size: 1.1rem; }

        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(41, 182, 246, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(41, 182, 246, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(41, 182, 246, 0); } }
    </style>
</head>
<body>

<div class="intro-modal" id="intro-screen">
    <h1 style="color:#fff; margin-bottom:30px;">ğŸš€ è«‹é¸æ“‡æŒ‘æˆ°ç­‰ç´š</h1>
    <button class="grade-btn g-low" onclick="setGrade('low')">ğŸ‘¶ ä½å¹´ç´š (1-2)</button>
    <button class="grade-btn g-mid" onclick="setGrade('mid')">ğŸ‘¦ ä¸­å¹´ç´š (3-4)</button>
    <button class="grade-btn g-high" onclick="setGrade('high')">ğŸ§‘â€ğŸ“ é«˜å¹´ç´š (5-6)</button>
</div>

<div id="hud" style="display:none;">
    <div class="status-box">
        <span id="grade-display" class="grade-badge"></span>
        <span>â±ï¸ <span id="total-time">0</span>s</span>
    </div>
    <div class="status-box">
        <div class="item-icon" onclick="useItem('time')">â³<span class="item-count" id="c-time">0</span></div>
        <div class="item-icon" onclick="useItem('shield')">ğŸ›¡ï¸<span class="item-count" id="c-shield">0</span></div>
        <div class="item-icon" onclick="useItem('key')">ğŸ”‘<span class="item-count" id="c-key">0</span></div>
    </div>
</div>

<div id="map-viewport">
    <div class="zone zone-5"><div class="zone-label">World 5: æ©Ÿæ¢°åŸå ¡</div></div>
    <div class="zone zone-4"><div class="zone-label">World 4: ç†”å²©ç«å±±</div></div>
    <div class="zone zone-3"><div class="zone-label">World 3: æ¥µåœ°å†°åŸ</div></div>
    <div class="zone zone-2"><div class="zone-label">World 2: çƒˆæ—¥æ²™æ¼ </div></div>
    <div class="zone zone-1"><div class="zone-label">World 1: è¿·éœ§æ£®æ—</div></div>
    <svg id="path-svg"><path id="map-path" d=""/></svg>
    <div id="nodes-container"></div>
</div>

<div class="modal" id="game-modal">
    <div class="game-board">
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span id="lv-title">Level 1</span>
            <span id="q-timer" style="color:red;">30s</span>
        </div>
        <div style="height:5px; background:#eee; margin:10px 0;"><div id="t-bar" style="height:100%; width:100%; background:red;"></div></div>
        <div class="game-content" id="q-content">?</div>
        <div class="grid-options" id="q-opts"></div>
        <div style="margin-top:20px; display:flex; justify-content:center; gap:10px;">
            <button onclick="useItem('time')" style="padding:5px 10px;">â³</button>
            <button onclick="useItem('shield')" style="padding:5px 10px;">ğŸ›¡ï¸</button>
            <button onclick="useItem('key')" style="padding:5px 10px;">ğŸ”‘</button>
        </div>
    </div>
</div>

<div class="modal" id="win-modal">
    <div class="game-board">
        <h1>ğŸ† æŒ‘æˆ°æˆåŠŸï¼</h1>
        <p>ç­‰ç´šï¼š<span id="final-grade"></span></p>
        <p>ç¸½è€—æ™‚ï¼š<span id="final-time" style="font-size:2rem; color:red;"></span> ç§’</p>
        <input type="text" id="input-name" placeholder="è¼¸å…¥ä½ çš„åå­—" style="padding:10px; font-size:1.2rem; width:80%;">
        <br><br>
        <button class="opt-btn" onclick="submitScore()">ä¸Šå‚³è‹±é›„æ¦œ</button>
        <button class="opt-btn" style="background:#777; margin-top:10px;" onclick="location.reload()">å›é¦–é </button>
    </div>
</div>

<div class="modal" id="rank-modal">
    <div class="game-board" style="max-height:80vh; overflow-y:auto;">
        <h2>ğŸ† è‹±é›„æ¦œ</h2>
        <div class="rank-tabs">
            <button class="rt-btn active" onclick="loadRank('low', this)">ä½å¹´ç´š</button>
            <button class="rt-btn" onclick="loadRank('mid', this)">ä¸­å¹´ç´š</button>
            <button class="rt-btn" onclick="loadRank('high', this)">é«˜å¹´ç´š</button>
        </div>
        <div id="rank-list" style="text-align:left;">è¼‰å…¥ä¸­...</div>
        <button class="opt-btn" style="background:#555; margin-top:20px; font-size:1rem; padding:10px;" onclick="document.getElementById('rank-modal').classList.remove('active')">é—œé–‰</button>
    </div>
</div>

<style> body { padding-bottom: 70px !important; } #jetpay-navbar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #fff; border-top: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center; z-index: 9999; } .nav-item { text-decoration: none; color: #555; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; } .nav-icon { font-size: 1.5rem; } </style>
<div id="jetpay-navbar">
    <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>é¦–é </span></a>
    <a href="#" class="nav-item" onclick="openRank()"><span class="nav-icon">ğŸ†</span><span>æ’è¡Œ</span></a>
</div>

<script>
    // ğŸ”´ ğŸ”´ ğŸ”´ è¨˜å¾—æ› GAS ç¶²å€ ğŸ”´ ğŸ”´ ğŸ”´
    const API_URL = "https://script.google.com/macros/s/AKfycbwKUB2BPH1jD7ch2yenKSokuHq15ktPk1UfORI0RVNYVL6_oIBISNr27MX5Yng-7i-DqA/exec";

    const TOTAL_LEVELS = 30;
    let state = {
        grade: 'mid', // é è¨­
        level: 1,
        items: { time: 1, shield: 1, key: 0 },
        totalTime: 0,
        timer: null,
        inGame: false,
        shieldOn: false
    };

    // 1. è¨­å®šå¹´ç´š
    function setGrade(g) {
        state.grade = g;
        document.getElementById('intro-screen').style.display = 'none';
        document.getElementById('hud').style.display = 'flex';
        
        // è¨­å®šå¾½ç« é¡è‰²
        const badge = document.getElementById('grade-display');
        const map = {'low':'ğŸ‘¶ ä½å¹´ç´š','mid':'ğŸ‘¦ ä¸­å¹´ç´š','high':'ğŸ§‘â€ğŸ“ é«˜å¹´ç´š'};
        const color = {'low':'#4caf50','mid':'#ff9800','high':'#f44336'};
        badge.innerText = map[g];
        badge.style.background = color[g];

        // è®€å–å­˜æª” (åˆ†é–‹å­˜)
        loadProgress(g);
        renderMap();
        updateHUD();
        
        setTimeout(() => {
            const curr = document.querySelector('.level-node.unlocked');
            if(curr) curr.scrollIntoView({block:"center", behavior:"smooth"});
        }, 500);
    }

    // 2. åœ°åœ–æ¸²æŸ“
    function renderMap() {
        const con = document.getElementById('nodes-container');
        con.innerHTML = '';
        let d = "M 50% 3500";
        for(let i=1; i<=TOTAL_LEVELS; i++) {
            let y = 3500 - (i*110);
            let x = 50 + Math.sin(i)*30;
            d += ` L ${x}% ${y}`;
            
            const n = document.createElement('div');
            n.className = `level-node ${i<state.level?'cleared':(i==state.level?'unlocked':'')}`;
            n.style.left = `calc(${x}% - 27px)`;
            n.style.top = `${y}px`;
            n.innerText = i;
            if(i <= state.level) n.onclick = () => startLevel(i);
            con.appendChild(n);
        }
        document.getElementById('map-path').setAttribute('d', d.replace(/50%/g, window.innerWidth/2));
    }

    // 3. éŠæˆ²é‚è¼¯ (åˆ†ç´šé¡Œç›®)
    function startLevel(lv) {
        if(lv > state.level) return;
        state.inGame = true;
        state.shieldOn = false;
        document.getElementById('game-modal').classList.add('active');
        document.getElementById('lv-title').innerText = `Level ${lv}`;
        
        genQuestion(lv);
        
        let t = 30;
        document.getElementById('q-timer').innerText = t;
        if(state.timer) clearInterval(state.timer);
        state.timer = setInterval(() => {
            t--; state.totalTime++;
            document.getElementById('q-timer').innerText = t;
            document.getElementById('t-bar').style.width = (t/30*100)+"%";
            document.getElementById('total-time').innerText = state.totalTime;
            if(t<=0) gameOver();
        }, 1000);
    }

    function genQuestion(lv) {
        const qDiv = document.getElementById('q-content');
        const optsDiv = document.getElementById('q-opts');
        optsDiv.innerHTML = '';
        const r = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
        let q, a, opts;

        // --- åˆ†ç´šå‡ºé¡Œæ ¸å¿ƒ ---
        if(state.grade === 'low') {
            // ä½å¹´ç´šï¼š20ä»¥å…§åŠ æ¸›ã€é¡è‰²
            if(lv % 2 !== 0) {
                let n1=r(1,10), n2=r(1,9);
                q=`${n1} + ${n2} = ?`; a=n1+n2;
                opts=[a, a+1, a-1, a+2];
            } else {
                let cs=['ğŸ”´','ğŸ”µ','ğŸŸ¢','ğŸŸ¡']; let txt=['ç´…','è—','ç¶ ','é»ƒ'];
                let idx=r(0,3); q=`é¸å‡º ${txt[idx]}è‰²`; a=cs[idx];
                opts=cs;
            }
        } else if(state.grade === 'mid') {
            // ä¸­å¹´ç´šï¼šä¹˜æ³•ã€ç°¡æ˜“æ•¸åˆ—
            if(lv % 2 !== 0) {
                let n1=r(2,9), n2=r(2,9);
                q=`${n1} Ã— ${n2} = ?`; a=n1*n2;
                opts=[a, a+n2, a-n2, a+10];
            } else {
                let start=r(1,5), step=r(2,5);
                q=`${start}, ${start+step}, ${start+step*2}, ?`; a=start+step*3;
                opts=[a, a+1, a-1, a+2];
            }
        } else {
            // é«˜å¹´ç´šï¼šæ··åˆé‹ç®—ã€å¤§æ•¸
            let n1=r(11,20), n2=r(2,9), n3=r(1,50);
            q=`${n1} Ã— ${n2} - ${n3} = ?`; a=n1*n2-n3;
            opts=[a, a+10, a-5, a+1];
        }

        qDiv.innerText = q;
        opts.sort(()=>0.5-Math.random()).forEach(o => {
            const b = document.createElement('button');
            b.className='opt-btn'; b.innerText=o;
            b.onclick = () => checkAns(o, a);
            optsDiv.appendChild(b);
        });
    }

    function checkAns(ans, correct) {
        if(!state.inGame) return;
        if(String(ans) === String(correct)) {
            winLevel();
        } else {
            if(state.shieldOn) {
                alert("ğŸ›¡ï¸ è­·ç›¾ç”Ÿæ•ˆï¼"); state.shieldOn=false;
            } else {
                alert("âŒ ç­”éŒ¯ç½°æ™‚ +5ç§’"); state.totalTime+=5;
            }
        }
    }

    function winLevel() {
        clearInterval(state.timer);
        state.inGame = false;
        document.getElementById('game-modal').classList.remove('active');
        
        if(state.level % 3 === 0) {
            let gift = ['time','shield','key'][Math.floor(Math.random()*3)];
            state.items[gift]++;
            alert(`ğŸ ç²å¾—é“å…·ï¼š${gift}`);
        }

        if(state.level < TOTAL_LEVELS) {
            state.level++;
            saveProgress(state.grade);
            renderMap();
            setTimeout(() => {
                document.querySelector('.level-node.unlocked').scrollIntoView({block:"center",behavior:"smooth"});
            }, 300);
        } else {
            gameWin();
        }
        updateHUD();
    }

    function gameOver() {
        clearInterval(state.timer); state.inGame=false;
        alert("ğŸ’€ æ™‚é–“åˆ°ï¼");
        document.getElementById('game-modal').classList.remove('active');
    }

    function gameWin() {
        document.getElementById('win-modal').classList.add('active');
        document.getElementById('final-time').innerText = state.totalTime;
        document.getElementById('final-grade').innerText = document.getElementById('grade-display').innerText;
    }

    // 4. é“å…·
    function useItem(type) {
        if(state.items[type]>0) {
            state.items[type]--;
            if(type==='time') { state.totalTime-=10; alert("æ™‚é–“-10s"); }
            if(type==='shield') { state.shieldOn=true; alert("è­·ç›¾é–‹å•Ÿ"); }
            if(type==='key') { winLevel(); }
            updateHUD();
            saveProgress(state.grade);
        }
    }
    
    function updateHUD() {
        document.getElementById('c-time').innerText = state.items.time;
        document.getElementById('c-shield').innerText = state.items.shield;
        document.getElementById('c-key').innerText = state.items.key;
        document.getElementById('total-time').innerText = state.totalTime;
    }

    // 5. å­˜æª”
    function saveProgress(g) {
        const d = { level: state.level, items: state.items, time: state.totalTime };
        localStorage.setItem('adv_save_' + g, JSON.stringify(d));
    }
    function loadProgress(g) {
        const s = localStorage.getItem('adv_save_' + g);
        if(s) {
            const d = JSON.parse(s);
            state.level = d.level; state.items = d.items; state.totalTime = d.time;
        } else {
            state.level = 1; state.items = {time:1,shield:1,key:0}; state.totalTime = 0;
        }
    }

    // 6. æ’è¡Œæ¦œ
    function submitScore() {
        const n = document.getElementById('input-name').value;
        if(!n) return;
        fetch(API_URL, {
            method:'POST',
            body:JSON.stringify({type:'record', name:n, time:state.totalTime, grade:state.grade})
        }).then(()=>{ alert("ä¸Šå‚³æˆåŠŸ"); location.reload(); });
    }

    function openRank() {
        document.getElementById('rank-modal').classList.add('active');
        loadRank(state.grade); // é è¨­è¼‰å…¥ç•¶å‰å¹´ç´š
    }

    function loadRank(grade, btn) {
        if(btn) {
            document.querySelectorAll('.rt-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
        }
        const div = document.getElementById('rank-list');
        div.innerHTML = "è¼‰å…¥ä¸­...";
        fetch(API_URL + `?action=getRank&grade=${grade}`)
            .then(r=>r.json())
            .then(d=>{
                div.innerHTML = "";
                if(d.length==0) div.innerHTML = "å°šç„¡ç´€éŒ„";
                d.slice(0,10).forEach((row,i) => {
                    div.innerHTML += `<div class="rank-row"><span>#${i+1} ${row.name}</span><span>${row.time}s</span></div>`;
                });
            });
    }

</script>
</body>
</html>