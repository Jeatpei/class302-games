<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‚‘ç‰¹ä½©å¤§å†’éšªï¼šæ™‚ç©ºç©¿è¶Šè€…</title>
    <style>
        :root { --bg-map: #81c784; --path: #fff; --locked: #555; --cleared: #ffca28; }
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; margin: 0; padding: 0; background: #333; color: white; user-select: none; overflow: hidden; }

        /* === ğŸ—ºï¸ åœ°åœ–å€ (å¯æ²å‹•) === */
        #map-viewport {
            width: 100%; height: 100vh; overflow-y: auto; overflow-x: hidden;
            background: linear-gradient(180deg, #2c3e50 0%, #4a148c 30%, #006064 60%, #1b5e20 100%);
            position: relative; scroll-behavior: smooth; padding-bottom: 80px; /* é¿é–‹å°èˆª */
        }
        
        .world-label {
            position: absolute; width: 100%; text-align: center; font-size: 3rem; font-weight: bold;
            opacity: 0.3; color: white; pointer-events: none; z-index: 0; text-transform: uppercase;
        }

        /* é—œå¡ç¯€é» */
        .level-node {
            position: absolute; width: 50px; height: 50px; border-radius: 50%;
            background: var(--locked); border: 4px solid #fff; left: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem; cursor: pointer; z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.3s;
        }
        .level-node.unlocked { background: #03a9f4; animation: pulse 2s infinite; }
        .level-node.cleared { background: var(--cleared); color: #333; border-color: #ff6f00; }
        .level-node:hover { transform: scale(1.2); }

        /* é€£æ¥ç·š (SVG) */
        #path-svg { position: absolute; top: 0; left: 0; width: 100%; height: 3500px; pointer-events: none; z-index: 1; }
        path { fill: none; stroke: rgba(255,255,255,0.3); stroke-width: 8; stroke-dasharray: 10; }

        /* === ğŸ’ HUD æŠ¬é ­é¡¯ç¤ºå™¨ === */
        #hud {
            position: fixed; top: 0; left: 0; width: 100%; padding: 10px;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 100;
            display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;
        }
        .status-box { font-size: 0.9rem; display: flex; gap: 15px; }
        .item-icon { font-size: 1.2rem; cursor: pointer; position: relative; }
        .item-count { position: absolute; bottom: -5px; right: -5px; background: red; font-size: 0.7rem; padding: 1px 4px; border-radius: 10px; }

        /* === âš”ï¸ éŠæˆ²æˆ°é¬¥è¦–çª— (Modal) === */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center; z-index: 200; flex-direction: column;
        }
        .modal.active { display: flex; }
        
        .game-board {
            background: white; color: #333; width: 90%; max-width: 500px; border-radius: 15px;
            padding: 20px; text-align: center; position: relative; box-shadow: 0 0 50px rgba(255,255,255,0.2);
        }
        .game-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; }
        .timer-bar { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-bottom: 20px; }
        .timer-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 1s linear; }
        
        .game-content { min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; }
        
        /* éŠæˆ²é¡å‹æ¨£å¼ */
        .grid-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 20px; }
        .g-btn { padding: 15px; border: none; background: #2196f3; color: white; font-size: 1.2rem; border-radius: 10px; cursor: pointer; }
        .g-btn:active { transform: scale(0.95); }

        /* é“å…·ä½¿ç”¨æ¬„ */
        .power-ups { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .p-btn { background: #333; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; cursor: pointer; opacity: 0.5; }
        .p-btn.has-item { opacity: 1; background: #ff9800; border-color: #e65100; }

        /* æ’è¡Œæ¦œ */
        #rank-board { width: 90%; max-width: 400px; background: #fff; color: #333; border-radius: 10px; padding: 20px; max-height: 70vh; overflow-y: auto; }
        .rank-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .rank-row:nth-child(1) { color: #d35400; font-weight: bold; font-size: 1.1rem; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(3, 169, 244, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(3, 169, 244, 0); } 100% { box-shadow: 0 0 0 0 rgba(3, 169, 244, 0); } }
    </style>
</head>
<body>

<div id="hud">
    <div class="status-box">
        <span>ğŸ‘¤ <span id="p-name">æœªç™»å…¥</span></span>
        <span>ğŸ•’ ç¸½æ™‚é•·: <span id="total-time">0</span>s</span>
    </div>
    <div class="status-box">
        <div class="item-icon" onclick="useItem('time')">â³<span class="item-count" id="c-time">0</span></div>
        <div class="item-icon" onclick="useItem('shield')">ğŸ›¡ï¸<span class="item-count" id="c-shield">0</span></div>
        <div class="item-icon" onclick="useItem('key')">ğŸ”‘<span class="item-count" id="c-key">0</span></div>
    </div>
</div>

<div id="map-viewport">
    <div class="world-label" style="top: 3200px;">World 1: è¿·éœ§æ£®æ—</div>
    <div class="world-label" style="top: 2400px;">World 2: çƒˆæ—¥æ²™æ¼ </div>
    <div class="world-label" style="top: 1600px;">World 3: æ¥µåœ°å†°åŸ</div>
    <div class="world-label" style="top: 800px;">World 4: ç†”å²©ç«å±±</div>
    <div class="world-label" style="top: 100px;">World 5: æ©Ÿæ¢°åŸå ¡</div>
    <svg id="path-svg"><path id="map-path" d=""/></svg>
    <div id="nodes-container"></div>
</div>

<div class="modal" id="game-modal">
    <div class="game-board">
        <div class="game-header">
            <span id="level-title">Level 1</span>
            <span id="q-timer">30s</span>
        </div>
        <div class="timer-bar"><div class="timer-fill" id="t-fill"></div></div>
        
        <div class="game-content" id="g-content">
            é¡Œç›®è¼‰å…¥ä¸­...
        </div>
        <div class="grid-options" id="g-opts"></div>

        <div class="power-ups">
            <button class="p-btn" id="btn-time" onclick="triggerPower('time')">â³ æ™‚é–“+10s</button>
            <button class="p-btn" id="btn-shield" onclick="triggerPower('shield')">ğŸ›¡ï¸ å…æ­»ç›¾</button>
            <button class="p-btn" id="btn-key" onclick="triggerPower('key')">ğŸ”‘ è·³é—œ</button>
        </div>
    </div>
</div>

<div class="modal" id="win-modal">
    <div class="game-board">
        <h1>ğŸ† æ­å–œé€šé—œï¼</h1>
        <p>ä½ çš„å†’éšªç¸½æ™‚é•·ï¼š<span id="final-time" style="font-size:2rem; color:red;"></span> ç§’</p>
        <p>å¤ªå¼·äº†ï¼è«‹è¼¸å…¥åå­—ä¸Šå‚³æ’è¡Œæ¦œï¼š</p>
        <input type="text" id="input-name" placeholder="ä¾‹å¦‚ï¼š402 å°æ˜" style="padding:10px; font-size:1rem;">
        <br><br>
        <button class="g-btn" onclick="submitScore()">ä¸Šå‚³æˆç¸¾</button>
        <button class="g-btn" style="background:#555;" onclick="closeWin()">ç¨å¾Œå†å‚³</button>
    </div>
</div>

<div class="modal" id="rank-modal">
    <div id="rank-board">
        <h2 style="text-align:center;">ğŸ† å‚³èªªå†’éšªå®¶ ğŸ†</h2>
        <div id="rank-list">è¼‰å…¥ä¸­...</div>
        <button class="g-btn" style="width:100%; margin-top:20px;" onclick="closeRank()">é—œé–‰</button>
    </div>
</div>

<style> body { padding-bottom: 70px !important; } #jetpay-navbar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #fff; border-top: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center; z-index: 9999; } .nav-item { text-decoration: none; color: #555; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; } .nav-icon { font-size: 1.5rem; } </style>
<div id="jetpay-navbar">
    <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>é¦–é </span></a>
    <a href="adventure_map.html" class="nav-item" onclick="showRank()"><span class="nav-icon">ğŸ†</span><span>æ’è¡Œ</span></a>
</div>

<script>
    // ğŸ”´ è¨­å®šå€ï¼šè«‹å¡«å…¥æ‚¨çš„ GAS ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbwKUB2BPH1jD7ch2yenKSokuHq15ktPk1UfORI0RVNYVL6_oIBISNr27MX5Yng-7i-DqA/exec";

    // éŠæˆ²ç‹€æ…‹
    const TOTAL_LEVELS = 30;
    let state = {
        level: 1,
        items: { time: 1, shield: 1, key: 0 }, // åˆå§‹é€ä¸€äº›é“å…·
        totalTime: 0,
        gameTimer: null,
        levelTime: 0,
        inGame: false,
        shieldActive: false
    };

    // åˆå§‹åŒ–
    window.onload = function() {
        loadProgress();
        renderMap();
        updateHUD();
        // è‡ªå‹•æ²å‹•åˆ°ç›®å‰é—œå¡
        setTimeout(() => {
            const current = document.querySelector('.level-node.unlocked');
            if(current) current.scrollIntoView({block: "center", behavior: "smooth"});
        }, 500);
    };

    // --- ğŸ—ºï¸ åœ°åœ–ç”Ÿæˆç³»çµ± ---
    function renderMap() {
        const container = document.getElementById('nodes-container');
        let pathD = "M 50% 3450"; // èµ·é»
        let lastX = 50;
        let lastY = 3450;

        for (let i = 1; i <= TOTAL_LEVELS; i++) {
            const y = 3450 - (i * 110); // å¾€ä¸Šçˆ¬
            const x = 50 + Math.sin(i * 0.8) * 35; // å·¦å³è›‡è¡Œ (35% æŒ¯å¹…)
            
            // ç¹ªè£½è·¯å¾‘
            pathD += ` L ${x}% ${y}`;
            
            // ç¹ªè£½ç¯€é»
            const node = document.createElement('div');
            node.className = `level-node ${i < state.level ? 'cleared' : (i === state.level ? 'unlocked' : '')}`;
            node.style.left = `calc(${x}% - 25px)`;
            node.style.top = `${y}px`;
            node.innerText = i;
            
            if (i <= state.level) {
                node.onclick = () => enterLevel(i);
            }
            container.appendChild(node);
        }
        document.getElementById('map-path').setAttribute('d', pathD.replace(/50%/g, window.innerWidth/2)); // ç°¡æ˜“SVGä¿®æ­£
    }

    // --- âš”ï¸ é—œå¡é‚è¼¯ ---
    function enterLevel(lv) {
        if(lv > state.level) return;
        state.inGame = true;
        state.levelTime = 0;
        state.shieldActive = false;
        
        // é¡¯ç¤ºä»‹é¢
        document.getElementById('game-modal').classList.add('active');
        document.getElementById('level-title').innerText = `Level ${lv}`;
        
        // æ ¹æ“šé—œå¡ç”¢ç”Ÿä¸åŒéŠæˆ²
        generateGameContent(lv);
        
        // å•Ÿå‹•è¨ˆæ™‚
        const maxTime = 30; // æ¯é—œ30ç§’
        let timeLeft = maxTime;
        document.getElementById('t-fill').style.width = '100%';
        
        if(state.gameTimer) clearInterval(state.gameTimer);
        state.gameTimer = setInterval(() => {
            timeLeft--;
            state.levelTime++;
            state.totalTime++; // ç´¯è¨ˆç¸½éŠæˆ²æ™‚é–“
            updateHUD();
            
            document.getElementById('q-timer').innerText = timeLeft + "s";
            document.getElementById('t-fill').style.width = (timeLeft/maxTime*100) + "%";
            
            if(timeLeft <= 0) {
                gameOver("æ™‚é–“åˆ°ï¼");
            }
        }, 1000);
        
        updatePowerBtn();
    }

    function generateGameContent(lv) {
        // éŠæˆ²é¡å‹è¼ªæ›¿ï¼š1.æ•¸å­¸ 2.åæ‡‰ 3.å¯†ç¢¼
        const type = lv % 3; 
        const content = document.getElementById('g-content');
        const opts = document.getElementById('g-opts');
        opts.innerHTML = '';

        if(type === 1) { // ğŸ§® æ•¸å­¸é¡Œ (éš¨é—œå¡è®Šé›£)
            const n1 = Math.floor(Math.random() * (lv*5)) + 5;
            const n2 = Math.floor(Math.random() * 9) + 2;
            const ans = n1 * n2;
            content.innerText = `${n1} Ã— ${n2} = ?`;
            createOptions([ans, ans+n2, ans-n2, ans+10], ans);
        } else if (type === 2) { // âš¡ åæ‡‰é¡Œ
            const colors = ['ç´…','è—','ç¶ ','é»ƒ'];
            const cMap = {'ç´…':'red','è—':'blue','ç¶ ':'green','é»ƒ':'gold'};
            const txt = colors[Math.floor(Math.random()*4)];
            const col = colors[Math.floor(Math.random()*4)];
            content.innerHTML = `<span style="color:${cMap[col]}; font-size:3rem;">${txt}</span><br><span style="font-size:1rem">é»é¸æ–‡å­—é¡è‰²ï¼</span>`;
            createOptions(colors, col); // ç­”æ¡ˆæ˜¯é¡è‰²(col)ï¼Œä¸æ˜¯æ–‡å­—(txt)
        } else { // ğŸ” é‚è¼¯é¡Œ
            const seq = [2,4,6,8,10].map(x => x + lv);
            content.innerText = `${seq[0]}, ${seq[1]}, ${seq[2]}, ?`;
            createOptions([seq[3], seq[3]+1, seq[3]-1, seq[3]+2], seq[3]);
        }
    }

    function createOptions(arr, correct) {
        const opts = document.getElementById('g-opts');
        // æ‰“äº‚
        arr.sort(()=>0.5-Math.random()).forEach(val => {
            const btn = document.createElement('button');
            btn.className = 'g-btn';
            btn.innerText = val;
            btn.onclick = () => checkAnswer(val, correct);
            opts.appendChild(btn);
        });
    }

    function checkAnswer(val, correct) {
        if(!state.inGame) return;
        
        if(String(val) === String(correct)) {
            levelClear();
        } else {
            if(state.shieldActive) {
                alert("ğŸ›¡ï¸ è­·ç›¾æŠµæ“‹äº†ä¸€æ¬¡éŒ¯èª¤ï¼");
                state.shieldActive = false;
                document.getElementById('btn-shield').style.opacity = 0.5;
            } else {
                // æ‡²ç½°ï¼šæ™‚é–“æ‰£ 5 ç§’
                state.totalTime += 5; 
                alert("âŒ ç­”éŒ¯ï¼ç¸½æ™‚é–“ +5ç§’ æ‡²ç½°");
            }
        }
    }

    function levelClear() {
        clearInterval(state.gameTimer);
        state.inGame = false;
        alert(`ğŸ‰ é€šé—œï¼è€—æ™‚ ${state.levelTime} ç§’`);
        
        // çµ¦çå‹µ
        if(state.level % 3 === 0) { // æ¯3é—œé€é“å…·
            const gifts = ['time', 'shield', 'key'];
            const gift = gifts[Math.floor(Math.random()*3)];
            state.items[gift]++;
            alert(`ğŸ ç²å¾—é“å…·ï¼š${gift === 'time'?'æ²™æ¼':(gift==='shield'?'è­·ç›¾':'é‘°åŒ™')}`);
        }

        document.getElementById('game-modal').classList.remove('active');
        
        // å‡ç´š
        if(state.level < TOTAL_LEVELS) {
            state.level++;
        } else {
            gameComplete();
        }
        
        saveProgress();
        // é‡ç¹ªåœ°åœ– (ç°¡å–®æš´åŠ›é‡æ•´)
        location.reload();
    }

    function gameOver(msg) {
        clearInterval(state.gameTimer);
        state.inGame = false;
        alert(`ğŸ’€ ${msg} å†è©¦ä¸€æ¬¡å§ï¼`);
        document.getElementById('game-modal').classList.remove('active');
    }

    function gameComplete() {
        document.getElementById('win-modal').classList.add('active');
        document.getElementById('final-time').innerText = state.totalTime;
    }

    // --- ğŸ’ é“å…·èˆ‡å­˜æª”ç³»çµ± ---
    function triggerPower(type) {
        if(state.items[type] > 0) {
            if(type === 'time') {
                state.totalTime -= 10; // ç¸½æ™‚é–“æ¸›å°‘ (é€™æ˜¯ä½œå¼Šå™¨XD)
                alert("â³ ç¸½æ™‚é–“ -10ç§’ï¼");
            } else if(type === 'shield') {
                state.shieldActive = true;
                alert("ğŸ›¡ï¸ è­·ç›¾å·²å•Ÿå‹•ï¼");
            } else if(type === 'key') {
                levelClear(); // ç›´æ¥éé—œ
            }
            state.items[type]--;
            updateHUD();
            updatePowerBtn();
            saveProgress();
        }
    }

    function updatePowerBtn() {
        ['time','shield','key'].forEach(t => {
            const btn = document.getElementById('btn-'+t);
            if(state.items[t] > 0) btn.classList.add('has-item');
            else btn.classList.remove('has-item');
        });
    }

    function updateHUD() {
        document.getElementById('total-time').innerText = state.totalTime;
        document.getElementById('c-time').innerText = state.items.time;
        document.getElementById('c-shield').innerText = state.items.shield;
        document.getElementById('c-key').innerText = state.items.key;
    }

    function saveProgress() {
        const data = { level: state.level, items: state.items, time: state.totalTime };
        localStorage.setItem('jetpay_adventure', JSON.stringify(data));
    }

    function loadProgress() {
        const saved = localStorage.getItem('jetpay_adventure');
        if(saved) {
            const data = JSON.parse(saved);
            state.level = data.level;
            state.items = data.items;
            state.totalTime = data.time;
        }
    }

    // --- ğŸ† æ’è¡Œæ¦œèˆ‡ä¸Šå‚³ ---
    function submitScore() {
        const name = document.getElementById('input-name').value;
        if(!name) return alert("è«‹è¼¸å…¥åå­—");
        
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ type: 'record', name: name, time: state.totalTime }),
            headers: { "Content-Type": "text/plain" }
        }).then(res => res.json()).then(d => {
            alert("âœ… æˆç¸¾ä¸Šå‚³æˆåŠŸï¼");
            closeWin();
        });
    }

    function showRank() {
        document.getElementById('rank-modal').classList.add('active');
        const list = document.getElementById('rank-list');
        list.innerHTML = "è¼‰å…¥ä¸­...";
        
        fetch(API_URL + "?action=getRank")
            .then(res => res.json())
            .then(data => {
                list.innerHTML = "";
                data.slice(0, 10).forEach((r, i) => {
                    const row = document.createElement('div');
                    row.className = 'rank-row';
                    row.innerHTML = `<span>#${i+1} ${r.name}</span> <span>${r.time}s</span>`;
                    list.appendChild(row);
                });
            });
    }

    function closeWin() { document.getElementById('win-modal').classList.remove('active'); }
    function closeRank() { document.getElementById('rank-modal').classList.remove('active'); }

</script>

</body>
</html>